<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Musician's Practice Toolkit</title>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <script src="https://unpkg.com/wavesurfer.js@7"></script>
    <style>
        :root {
            --primary: #22c55e;
            --danger: #ef4444;
            --bg: #0f172a;
            --surface: #1e293b;
            --border: #334155;
            --text: #f1f5f9;
            --text-muted: #94a3b8;
        }
        *, *::before, *::after { box-sizing: border-box; }
        body { font-family: system-ui,-apple-system,sans-serif; background: var(--bg); color: var(--text); max-width: 860px; margin: 0 auto; padding: 1.5rem; line-height: 1.5; }
        h1 { text-align: center; margin: 0 0 1.5rem; font-weight: 800; font-size: clamp(1.3rem,5vw,2rem); }
        h2 { margin: 0 0 1.2rem; color: var(--text-muted); font-size: 0.78rem; text-transform: uppercase; letter-spacing: 1.5px; }

        .card { background: var(--surface); border: 2px solid var(--border); border-radius: 16px; padding: 1.5rem; margin-bottom: 1.5rem; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.4); transition: border-color 0.06s ease-out, box-shadow 0.06s ease-out; }
        .card.beat-flash { border-color: var(--primary) !important; box-shadow: 0 0 0 4px rgba(34,197,94,0.28), 0 10px 25px -5px rgba(0,0,0,0.4) !important; }


        /* DRONE */
        .drone-section { display: flex; flex-direction: column; gap: 1.2rem; }
        .selector-label { display: block; font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 0.4rem; font-weight: 700; }
        .root-grid { display: grid; grid-template-columns: repeat(6,1fr); gap: 5px; }
        .interval-grid { display: grid; grid-template-columns: repeat(auto-fill,minmax(56px,1fr)); gap: 5px; }
        .btn-toggle { background: var(--bg); border: 1px solid var(--border); color: var(--text); padding: 12px 3px; border-radius: 6px; cursor: pointer; font-size: 0.8rem; font-weight: 600; transition: all 0.15s; touch-action: manipulation; min-height: 44px; }
        .btn-toggle:hover:not(.active) { border-color: var(--primary); color: var(--primary); }
        .btn-toggle:active { opacity: 0.75; }
        .btn-toggle.active { background: var(--primary); border-color: var(--primary); color: #fff; }

        .settings-bar { display: flex; flex-wrap: wrap; gap: 10px; padding: 1rem; background: rgba(0,0,0,0.3); border-radius: 12px; align-items: center; justify-content: center; border: 1px solid var(--border); }
        .control-group { display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .switch-ui { display: flex; background: var(--bg); border-radius: 8px; padding: 3px; border: 1px solid var(--border); }
        .switch-ui button { background: transparent; color: var(--text-muted); border: none; padding: 10px 12px; font-size: 0.68rem; border-radius: 5px; cursor: pointer; font-weight: 700; min-height: 44px; touch-action: manipulation; transition: all 0.15s; }
        .switch-ui button:active { opacity: 0.75; }
        .switch-ui button.active { background: var(--primary); color: #fff; }

        .vol-row { display: flex; align-items: center; gap: 8px; width: 100%; }
        .vol-row input[type=range] { flex: 1; }
        input[type=range] { accent-color: var(--primary); cursor: pointer; width: 88px; height: 20px; }
        input[type=range]::-webkit-slider-thumb { width: 28px; height: 28px; }
        input[type=range]::-moz-range-thumb { width: 28px; height: 28px; border-radius: 50%; background: var(--primary); border: none; }

        #debug-console { background: #000; color: var(--primary); font-family: 'Courier New',monospace; font-size: 0.72rem; padding: 10px; border-radius: 8px; margin-top: 0.5rem; min-height: 65px; border: 1px solid #166534; white-space: pre-wrap; }
        .details-btn { background: none; border: none; color: var(--text-muted); font-size: 0.73rem; cursor: pointer; padding: 3px 0; text-decoration: underline; }

        /* METRONOME */
        .metro-layout { display: flex; flex-wrap: wrap; gap: 1.5rem; align-items: flex-start; justify-content: center; }
        .wheel-col { display: flex; flex-direction: column; align-items: center; gap: 0.75rem; }
        .wheel-outer { position: relative; width: 200px; height: 200px; user-select: none; touch-action: none; }
        #wheel { width: 100%; height: 100%; border-radius: 50%; background: radial-gradient(circle,#1e293b 30%,#0f172a 100%); border: 12px solid var(--border); cursor: grab; transition: border-color 0.06s, box-shadow 0.06s; }
        #wheel.beat-flash { border-color: var(--primary); box-shadow: 0 0 22px rgba(34,197,94,0.5); }
        #wheel::after { content:''; position: absolute; top: 6px; left: 50%; transform: translateX(-50%); width: 22px; height: 22px; background: var(--primary); border-radius: 50%; box-shadow: 0 0 8px rgba(34,197,94,0.7); }
        .bpm-container { position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); text-align: center; width: 130px; pointer-events: none; z-index: 2; }
        #bpm-display { font-size: 3.2rem; font-weight: 900; color: var(--text); cursor: pointer; line-height: 1; pointer-events: auto; }
        #bpm-input { width: 100%; background: transparent; border: none; color: var(--primary); font-size: 3.2rem; font-weight: 900; text-align: center; display: none; outline: none; pointer-events: auto; }
        #bpm-label { font-size: 0.62rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-top: 2px; }
        .bpm-adj { display: flex; align-items: center; gap: 8px; }
        .adj-btn { background: var(--bg); border: 1px solid var(--border); color: var(--text); width: 44px; height: 44px; border-radius: 50%; font-size: 1.2rem; cursor: pointer; font-weight: 700; display: flex; align-items: center; justify-content: center; transition: all 0.15s; touch-action: manipulation; }
        .adj-btn:hover { border-color: var(--primary); color: var(--primary); }
        .adj-btn:active { background: var(--primary); border-color: var(--primary); color: #fff; }

        .wheel-row { display: flex; flex-direction: column; align-items: center; gap: 0.75rem; }
        .wheel-and-adj { display: flex; flex-direction: column; align-items: center; gap: 0.75rem; }
        .start-tap-col { display: flex; flex-direction: row; gap: 0.5rem; width: 200px; }
        .metro-start-btn { flex: 2; font-size: 1.4rem; line-height: 1.4; border-radius: 14px; padding: 0.9rem 0.5rem; text-align: center; }
        .metro-tap-btn { flex: 1; font-size: 0.85rem; line-height: 1.4; text-align: center; padding: 0.5rem; border-radius: 10px; }
        .metro-controls { display: flex; flex-direction: column; gap: 1rem; flex: 1; min-width: 205px; }
        .seg-ctrl { display: flex; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; overflow: hidden; }
        .seg-ctrl button { flex: 1; background: transparent; color: var(--text-muted); border: none; border-right: 1px solid var(--border); padding: 12px 2px; font-size: 0.7rem; font-weight: 700; cursor: pointer; transition: all 0.15s; touch-action: manipulation; min-height: 44px; }
        .seg-ctrl button:last-child { border-right: none; }
        .seg-ctrl button:active { opacity: 0.75; }
        .seg-ctrl button.active { background: var(--primary); color: #fff; }
        .mode-row { display: flex; gap: 8px; }

        /* RECORDER */
        .recording-item { background: var(--surface); border: 1px solid var(--border); padding: 1.2rem; margin-bottom: 1rem; border-radius: 14px; }
        .wf-box { height: 88px; background: rgba(0,0,0,0.5); border-radius: 8px; margin: 12px 0; overflow: hidden; }

        /* BUTTONS */
        button.main-action { background: var(--primary); color: #fff; border: none; padding: 0.7rem 1.4rem; border-radius: 10px; font-weight: 700; cursor: pointer; font-size: 0.92rem; touch-action: manipulation; transition: filter 0.15s; min-height: 44px; }
        button.main-action:hover { filter: brightness(1.1); }
        button.main-action:active { filter: brightness(0.9); }
        button.main-action.is-active { background: var(--danger); }
        button.secondary { background: var(--border); color: var(--text); padding: 0.7rem 1.3rem; border-radius: 10px; font-weight: 700; cursor: pointer; border: 1px solid transparent; font-size: 0.92rem; touch-action: manipulation; transition: all 0.15s; min-height: 44px; }
        button.secondary:hover { border-color: var(--primary); }
        button.secondary:active { border-color: var(--primary); filter: brightness(1.15); }
        .num-input { background: var(--bg); border: 1px solid var(--border); color: var(--primary); padding: 5px; border-radius: 4px; width: 52px; text-align: center; font-weight: 700; }
        .stepper { display: flex; align-items: center; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; overflow: hidden; }
        .stepper-btn { background: transparent; border: none; color: var(--text); font-size: 1.1rem; font-weight: 700; cursor: pointer; width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; touch-action: manipulation; transition: background 0.1s; flex-shrink: 0; }
        .stepper-btn:hover { background: var(--border); }
        .stepper-btn:active { background: var(--primary); color: #fff; }
        .stepper-val { color: var(--primary); font-weight: 700; font-size: 0.9rem; min-width: 40px; text-align: center; padding: 0 2px; }

        /* RESPONSIVE */
        @media (max-width: 500px) {
            body { padding: 1rem 0.75rem; }
            .btn-toggle { font-size: 0.72rem; padding: 12px 1px; }
            .wheel-outer { width: 170px; height: 170px; }
            #bpm-display { font-size: 2.8rem; }
            .settings-bar { gap: 7px; padding: 0.75rem; }
            button.main-action, button.secondary { padding: 0.6rem 1rem; font-size: 0.85rem; }
            .metro-controls { min-width: unset; width: 100%; }
            .seg-ctrl button { font-size: 0.62rem; padding: 12px 2px; }
            .wheel-row { flex-direction: row; align-items: flex-start; }
            .wheel-and-adj { flex: 1; align-items: center; }
            .start-tap-col { flex-direction: column; width: auto; align-self: stretch; order: -1; flex: 0 0 96px; }
            .metro-start-btn { flex: 2; height: auto; font-size: 1.6rem; padding: 0.5rem; }
            .metro-tap-btn { flex: 1; font-size: 1rem; }
            #metro-vol-row { order: -1; }
        }
    </style>
</head>
<body>

<h1>üéµ Musician's Practice Toolkit</h1>


<!-- DRONE -->
<div class="card">
    <h2>Drone Machine</h2>
    <div class="drone-section">
        <div>
            <span class="selector-label">1. Root Note</span>
            <div class="root-grid" id="rootGrid"></div>
        </div>
        <div>
            <span class="selector-label">2. Chord Intervals</span>
            <div class="interval-grid" id="intervalGrid"></div>
        </div>
        <div class="settings-bar">
            <div class="control-group">
                <span class="selector-label">A Ref</span>
                <div class="stepper">
                    <button class="stepper-btn" id="droneRefMinus">‚àí</button>
                    <span class="stepper-val" id="droneRefVal">440</span>
                    <button class="stepper-btn" id="droneRefPlus">+</button>
                </div>
                <input type="hidden" id="droneRef" value="440">
            </div>
            <div class="control-group">
                <span class="selector-label">Octave</span>
                <div class="stepper">
                    <button class="stepper-btn" id="droneOctaveMinus">‚àí</button>
                    <span class="stepper-val" id="droneOctaveVal">4</span>
                    <button class="stepper-btn" id="droneOctavePlus">+</button>
                </div>
                <input type="hidden" id="droneOctave" value="4" min="1" max="6">
            </div>
            <div class="control-group" style="flex:1;min-width:140px;">
                <span class="selector-label">Volume</span>
                <div class="vol-row"><span style="font-size:0.85rem;">üîà</span><input type="range" id="droneVolume" min="0" max="1" step="0.05" value="0.7"><span style="font-size:0.85rem;">üîä</span></div>
            </div>
            <div class="control-group"><span class="selector-label">Tuning</span>
                <div class="switch-ui" id="tuningSwitch">
                    <button data-val="just" class="active">JUST</button>
                    <button data-val="equal">ET</button>
                </div>
            </div>
            <div class="control-group"><span class="selector-label">Wave</span>
                <div class="switch-ui" id="colorSwitch">
                    <button data-val="sine" class="active">SINE</button>
                    <button data-val="triangle">TRI</button>
                </div>
            </div>
            <div style="display:flex;gap:8px;">
                <button id="droneToggle" class="main-action">üéµ Start Drone</button>
                <button id="droneClear" class="secondary">üßπ Clear</button>
            </div>
        </div>
        <div>
            <button class="details-btn" id="detailsToggle">üî¨ Show Details</button>
            <div id="debug-console" style="display:none;"></div>
        </div>
    </div>
</div>

<!-- METRONOME -->
<div class="card" id="metro-card">
    <h2>Metronome</h2>
    <div class="metro-layout">
        <div class="wheel-col">
            <div class="wheel-row">
                <div class="wheel-and-adj">
                    <div class="wheel-outer">
                        <div class="bpm-container">
                            <div id="bpm-display">120</div>
                            <input type="number" id="bpm-input" min="40" max="280" inputmode="numeric">
                            <div id="bpm-label">BPM</div>
                        </div>
                        <div id="wheel"></div>
                    </div>
                    <div class="bpm-adj">
                        <button class="adj-btn" id="bpmMinus">‚àí</button>
                        <span style="font-size:0.68rem;color:var(--text-muted);">fine adjust</span>
                        <button class="adj-btn" id="bpmPlus">+</button>
                    </div>
                </div>
                <div class="start-tap-col">
                    <button id="metroStartBtn" class="main-action metro-start-btn">‚ñ∂<br>Start</button>
                    <button id="tapBtn" class="secondary metro-tap-btn">üëÜ<br>Tap</button>
                </div>
            </div>
        </div>
        <div class="metro-controls">
            <div>
                <span class="selector-label">Time Signature</span>
                <div class="seg-ctrl" id="timeSigCtrl">
                    <button data-val="2">2/4</button>
                    <button data-val="3">3/4</button>
                    <button data-val="4" class="active">4/4</button>
                    <button data-val="6">6/8</button>
                </div>
            </div>
            <div>
                <span class="selector-label">Subdivision</span>
                <div class="seg-ctrl" id="subdivCtrl">
                    <button data-val="1" class="active">‚ô© Beat</button>
                    <button data-val="2">‚ô™ 8th</button>
                    <button data-val="3">‚ô©¬≥ Trip</button>
                    <button data-val="4">‚ô¨ 16th</button>
                </div>
            </div>
            <div>
                <span class="selector-label">Click Sound</span>
                <div class="seg-ctrl" id="clickSoundCtrl">
                    <button data-val="clave" class="active">Clave</button>
                    <button data-val="click">Click</button>
                    <button data-val="rim">Rim</button>
                    <button data-val="cowbell">Cowbell</button>
                </div>
            </div>
            <div id="metro-vol-row">
                <span class="selector-label">Volume</span>
                <div class="vol-row"><span style="font-size:0.85rem;">üîá</span><input type="range" id="metroVolume" min="0" max="1" step="0.05" value="0.7"><span style="font-size:0.85rem;">üîä</span></div>
            </div>
            <div>
                <span class="selector-label">Output</span>
                <div class="mode-row">
                    <button id="soundToggle" class="btn-toggle" style="flex:1;">üîî Sound</button>
                    <button id="lightToggle" class="btn-toggle" style="flex:1;">‚ö° Light</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- AUDIO MEMOS -->
<div class="card">
    <h2>Audio Memos</h2>
    <div style="text-align:center;">
        <button id="recordToggle" class="main-action">üéôÔ∏è Start Recording</button>
    </div>
    <div id="rec-status" style="margin-top:0.75rem;height:20px;color:var(--primary);font-weight:700;font-size:0.8rem;text-align:center;"></div>
    <canvas id="liveWaveform" height="80" style="width:100%;display:none;border-radius:8px;background:rgba(0,0,0,0.5);margin-top:0.75rem;"></canvas>
</div>

<div id="memoList"></div>

<!-- MUSIC DICTIONARY -->
<div class="card">
    <h2>Music Dictionary</h2>
    <div style="position:relative;margin-bottom:1rem;">
        <input id="dictSearch" type="search" placeholder="Search terms, definitions, or language‚Ä¶"
            style="width:100%;background:var(--bg);border:1px solid var(--border);color:var(--text);border-radius:10px;padding:0.7rem 1rem 0.7rem 2.4rem;font-size:0.95rem;outline:none;box-sizing:border-box;"
            autocomplete="off" spellcheck="false">
        <span style="position:absolute;left:0.75rem;top:50%;transform:translateY(-50%);font-size:1rem;pointer-events:none;">üîç</span>
    </div>
    <div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:1rem;" id="dictLangFilter">
        <button class="btn-toggle active" data-lang="all">All</button>
        <button class="btn-toggle" data-lang="it">üáÆüáπ Italian</button>
        <button class="btn-toggle" data-lang="de">üá©üá™ German</button>
        <button class="btn-toggle" data-lang="fr">üá´üá∑ French</button>
        <button class="btn-toggle" data-lang="en">üá¨üáß English</button>
    </div>
    <div id="dictResults" style="display:flex;flex-direction:column;gap:6px;max-height:480px;overflow-y:auto;"></div>
    <div id="dictCount" style="margin-top:0.6rem;font-size:0.72rem;color:var(--text-muted);text-align:right;"></div>
</div>

<script>
// ‚îÄ‚îÄ‚îÄ AUDIO CONTEXT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let audioCtx, db;
const getCtx = () => {
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    if (audioCtx.state === 'suspended') audioCtx.resume();
    return audioCtx;
};

// ‚îÄ‚îÄ‚îÄ PERSISTENCE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const PREFS_KEY = 'toolkit_prefs_v1';
function loadPrefs() { try { return JSON.parse(localStorage.getItem(PREFS_KEY)) || {}; } catch { return {}; } }
function savePrefs() {
    try {
        localStorage.setItem(PREFS_KEY, JSON.stringify({
            bpm, timeSig, subdivision, metroSound, metroLight,
            metroVolume, clickSound,
            droneRoot: droneState.root,
            droneIntervals: [...droneState.intervals],
            droneTuning: droneState.tuning,
            droneColor: droneState.color,
            droneOctave: droneState.octave,
            droneVolume: droneState.volume,
            droneRef: parseFloat(document.getElementById('droneRef').value) || 440
        }));
    } catch(e) {}
}

// ‚îÄ‚îÄ‚îÄ INDEXEDDB ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const initDB = () => new Promise(res => {
    const req = indexedDB.open('MusiciansToolkit', 1);
    req.onupgradeneeded = e => e.target.result.createObjectStore('memos', { keyPath: 'id' });
    req.onsuccess = e => { db = e.target.result; res(); };
});

// ‚îÄ‚îÄ‚îÄ DRONE DATA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const noteNames = ["C","C#","D","Eb","E","F","F#","G","Ab","A","Bb","B"];
const droneRatios = [
    {n:"Uni",s:0, r:1,      f:"1/1"},   {n:"m2", s:1,  r:16/15, f:"16/15"},
    {n:"M2", s:2, r:9/8,    f:"9/8"},   {n:"m3", s:3,  r:6/5,   f:"6/5"},
    {n:"M3", s:4, r:5/4,    f:"5/4"},   {n:"P4", s:5,  r:4/3,   f:"4/3"},
    {n:"TT", s:6, r:7/5,    f:"7/5"},   {n:"P5", s:7,  r:3/2,   f:"3/2"},
    {n:"m6", s:8, r:8/5,    f:"8/5"},   {n:"M6", s:9,  r:5/3,   f:"5/3"},
    {n:"m7", s:10,r:16/9,   f:"16/9"},  {n:"M7", s:11, r:15/8,  f:"15/8"},
    {n:"Oct",s:12,r:2,      f:"2/1"}
];

// ‚îÄ‚îÄ‚îÄ DRONE STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const prefs = loadPrefs();
let droneState = {
    root:     prefs.droneRoot     ?? 9,
    intervals:new Set(prefs.droneIntervals ?? [0]),
    tuning:   prefs.droneTuning   ?? 'just',
    color:    prefs.droneColor    ?? 'sine',
    running:  false,
    octave:   prefs.droneOctave   ?? 4,
    volume:   prefs.droneVolume   ?? 0.7
};
let activeOscs = [], droneMaster = null;

function getDroneMaster() {
    const ctx = getCtx();
    if (!droneMaster || droneMaster.context !== ctx) {
        droneMaster = ctx.createGain();
        droneMaster.gain.value = droneState.volume;
        droneMaster.connect(ctx.destination);
    }
    return droneMaster;
}

function getIntervalLabel() {
    return [...droneState.intervals].sort((a,b)=>a-b)
        .map(s => droneRatios.find(r=>r.s===s).n).join('+');
}

function updateDroneDebug() {
    const refA = parseFloat(document.getElementById('droneRef').value) || 440;
    const rootFreq = (refA * Math.pow(2,(droneState.root-9)/12)) * Math.pow(2,droneState.octave-4);
    let txt = `ROOT: ${noteNames[droneState.root]} @ ${rootFreq.toFixed(2)}Hz\nMODE: ${droneState.tuning.toUpperCase()}\n\n`;
    [...droneState.intervals].sort((a,b)=>a-b).forEach(s => {
        const iv = droneRatios.find(r=>r.s===s);
        const freq = droneState.tuning==='equal' ? rootFreq*Math.pow(2,s/12) : rootFreq*iv.r;
        const ratio = droneState.tuning==='equal' ? `2^(${s}/12)` : `${iv.f} (${iv.r.toFixed(3)})`;
        txt += `${iv.n.padEnd(4)}: ${freq.toFixed(2)}Hz | ${ratio}\n`;
    });
    document.getElementById('debug-console').innerText = txt;
    savePrefs();
}

function startDrone() {
    const ctx = getCtx();
    const refA = parseFloat(document.getElementById('droneRef').value) || 440;
    const rootFreq = (refA * Math.pow(2,(droneState.root-9)/12)) * Math.pow(2,droneState.octave-4);
    const master = getDroneMaster();
    droneState.intervals.forEach(s => {
        const iv = droneRatios.find(r=>r.s===s);
        const f = droneState.tuning==='equal' ? rootFreq*Math.pow(2,s/12) : rootFreq*iv.r;
        const osc = ctx.createOscillator(), g = ctx.createGain();
        osc.type = droneState.color;
        osc.frequency.setValueAtTime(f, ctx.currentTime);
        g.gain.setValueAtTime(0, ctx.currentTime);
        g.gain.linearRampToValueAtTime(0.15, ctx.currentTime+0.12);
        osc.connect(g).connect(master);
        osc.start();
        activeOscs.push({osc, g});
    });
}

const stopDrone = () => {
    const ctx = getCtx();
    activeOscs.forEach(n => {
        n.g.gain.linearRampToValueAtTime(0, ctx.currentTime+0.1);
        setTimeout(() => { try { n.osc.stop(); } catch(e){} }, 150);
    });
    activeOscs = [];
};

const droneSync = () => { updateDroneDebug(); if(droneState.running){ stopDrone(); startDrone(); } };

// Build root grid
noteNames.forEach((n,i) => {
    const b = document.createElement('button');
    b.className='btn-toggle'; b.textContent=n;
    if(i===droneState.root) b.classList.add('active');
    b.onclick = () => {
        document.querySelectorAll('#rootGrid .btn-toggle').forEach(x=>x.classList.remove('active'));
        b.classList.add('active'); droneState.root=i; droneSync();
    };
    document.getElementById('rootGrid').appendChild(b);
});

// Build interval grid
droneRatios.forEach(rt => {
    const b = document.createElement('button');
    b.className='btn-toggle'; b.textContent=rt.n;
    if(droneState.intervals.has(rt.s)) b.classList.add('active');
    b.onclick = () => {
        if(droneState.intervals.has(rt.s) && droneState.intervals.size>1) {
            droneState.intervals.delete(rt.s); b.classList.remove('active');
        } else {
            droneState.intervals.add(rt.s); b.classList.add('active');
        }
        droneSync();
    };
    document.getElementById('intervalGrid').appendChild(b);
});

document.getElementById('droneToggle').onclick = function() {
    droneState.running = !droneState.running;
    if(droneState.running){ startDrone(); this.textContent='üéµ Stop Drone'; this.classList.add('is-active'); }
    else { stopDrone(); this.textContent='üéµ Start Drone'; this.classList.remove('is-active'); }
};

document.getElementById('droneClear').onclick = () => {
    droneState.intervals = new Set([0]);
    document.querySelectorAll('#intervalGrid .btn-toggle').forEach((b,i)=>b.classList.toggle('active',i===0));
    droneSync();
};

// Restore saved values
const droneRefInput = document.getElementById('droneRef');
const droneRefVal   = document.getElementById('droneRefVal');
const droneOctaveInput = document.getElementById('droneOctave');
const droneOctaveVal   = document.getElementById('droneOctaveVal');

if(prefs.droneRef) { droneRefInput.value = prefs.droneRef; droneRefVal.textContent = prefs.droneRef; }
droneOctaveInput.value = droneState.octave;
droneOctaveVal.textContent = droneState.octave;

document.getElementById('droneRefMinus').onclick = () => {
    const v = Math.max(400, (parseFloat(droneRefInput.value)||440) - 1);
    droneRefInput.value = v; droneRefVal.textContent = v; droneSync();
};
document.getElementById('droneRefPlus').onclick = () => {
    const v = Math.min(480, (parseFloat(droneRefInput.value)||440) + 1);
    droneRefInput.value = v; droneRefVal.textContent = v; droneSync();
};
document.getElementById('droneOctaveMinus').onclick = () => {
    const v = Math.max(1, (parseInt(droneOctaveInput.value)||4) - 1);
    droneOctaveInput.value = v; droneOctaveVal.textContent = v; droneState.octave=v; droneSync();
};
document.getElementById('droneOctavePlus').onclick = () => {
    const v = Math.min(6, (parseInt(droneOctaveInput.value)||4) + 1);
    droneOctaveInput.value = v; droneOctaveVal.textContent = v; droneState.octave=v; droneSync();
};

// Volume slider
document.getElementById('droneVolume').value = droneState.volume;
document.getElementById('droneVolume').oninput = e => {
    droneState.volume = parseFloat(e.target.value);
    if(droneMaster) droneMaster.gain.value = droneState.volume;
    savePrefs();
};

// Tuning + wave switches ‚Äî restore saved state
['tuningSwitch','colorSwitch'].forEach(id => {
    const key = id==='tuningSwitch' ? 'tuning' : 'color';
    document.querySelectorAll(`#${id} button`).forEach(b => b.classList.toggle('active', b.dataset.val===droneState[key]));
    document.getElementById(id).onclick = e => {
        if(e.target.tagName!=='BUTTON') return;
        document.querySelectorAll(`#${id} button`).forEach(b=>b.classList.remove('active'));
        e.target.classList.add('active');
        droneState[key]=e.target.dataset.val; droneSync();
    };
});

// Details toggle
const detailsBtn = document.getElementById('detailsToggle');
const debugEl    = document.getElementById('debug-console');
detailsBtn.onclick = () => {
    const open = debugEl.style.display !== 'none';
    debugEl.style.display = open ? 'none' : 'block';
    detailsBtn.textContent = open ? 'üî¨ Show Details' : 'üî¨ Hide Details';
};

// ‚îÄ‚îÄ‚îÄ METRONOME STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let bpm         = prefs.bpm         ?? 120;
let timeSig     = prefs.timeSig     ?? 4;
let subdivision = prefs.subdivision ?? 1;
let metroSound  = prefs.metroSound  ?? false;
let metroLight  = prefs.metroLight  ?? false;
let metroVolume = prefs.metroVolume ?? 0.7;
let clickSound  = prefs.clickSound  ?? 'clave';
let metroRunning=false, nextBeat=0, schedTimer, beatCount=0;
let metroMaster = null;

function getMetroMaster() {
    const ctx = getCtx();
    if (!metroMaster || metroMaster.context !== ctx) {
        metroMaster = ctx.createGain();
        metroMaster.gain.value = metroVolume;
        metroMaster.connect(ctx.destination);
    }
    return metroMaster;
}

const bpmDisplay = document.getElementById('bpm-display');
const bpmInput   = document.getElementById('bpm-input');
const metroCard  = document.getElementById('metro-card');
const wheelEl    = document.getElementById('wheel');

const updateBPMDisplay = v => {
    bpm = Math.min(Math.max(v,40),280);
    bpmDisplay.textContent = bpm;
    bpmInput.value = bpm;
    wheelEl.style.transform = `rotate(${bpm*1.5}deg)`;
};
const updateBPM = v => { updateBPMDisplay(v); savePrefs(); };

bpmDisplay.onclick = () => { bpmDisplay.style.display='none'; bpmInput.style.display='block'; bpmInput.focus(); };
bpmInput.onblur   = () => { updateBPM(parseInt(bpmInput.value)||120); bpmInput.style.display='none'; bpmDisplay.style.display='block'; };
bpmInput.onkeydown = e => { if(e.key==='Enter') bpmInput.blur(); };
document.getElementById('bpmMinus').onclick = () => updateBPM(bpm-1);
document.getElementById('bpmPlus').onclick  = () => updateBPM(bpm+1);

// Metro volume slider
document.getElementById('metroVolume').value = metroVolume;
document.getElementById('metroVolume').oninput = e => {
    metroVolume = parseFloat(e.target.value);
    if(metroMaster) metroMaster.gain.value = metroVolume;
    savePrefs();
};

// Restore seg controls
document.querySelectorAll('#timeSigCtrl button').forEach(b=>b.classList.toggle('active',parseInt(b.dataset.val)===timeSig));
document.querySelectorAll('#subdivCtrl  button').forEach(b=>b.classList.toggle('active',parseInt(b.dataset.val)===subdivision));
document.querySelectorAll('#clickSoundCtrl button').forEach(b=>b.classList.toggle('active',b.dataset.val===clickSound));

document.getElementById('timeSigCtrl').onclick = e => {
    if(e.target.tagName!=='BUTTON') return;
    document.querySelectorAll('#timeSigCtrl button').forEach(b=>b.classList.remove('active'));
    e.target.classList.add('active');
    timeSig=parseInt(e.target.dataset.val); beatCount=0; savePrefs();
};
document.getElementById('subdivCtrl').onclick = e => {
    if(e.target.tagName!=='BUTTON') return;
    document.querySelectorAll('#subdivCtrl button').forEach(b=>b.classList.remove('active'));
    e.target.classList.add('active');
    subdivision=parseInt(e.target.dataset.val); savePrefs();
};
document.getElementById('clickSoundCtrl').onclick = e => {
    if(e.target.tagName!=='BUTTON') return;
    document.querySelectorAll('#clickSoundCtrl button').forEach(b=>b.classList.remove('active'));
    e.target.classList.add('active');
    clickSound=e.target.dataset.val; savePrefs();
};

// ‚îÄ‚îÄ‚îÄ CLICK SOUNDS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function playClave(atTime, isAccent) {
    const ctx = getCtx(), SR = ctx.sampleRate, out = getMetroMaster();
    const vol = isAccent ? 1.0 : 0.60, freq = isAccent ? 2750 : 2450;
    const body = ctx.createOscillator(), bG = ctx.createGain();
    body.type='sine';
    body.frequency.setValueAtTime(freq, atTime);
    body.frequency.exponentialRampToValueAtTime(freq*0.87, atTime+0.045);
    bG.gain.setValueAtTime(vol*0.6, atTime);
    bG.gain.exponentialRampToValueAtTime(0.001, atTime+0.045);
    body.connect(bG).connect(out); body.start(atTime); body.stop(atTime+0.055);

    const cLen=Math.floor(SR*0.013), nbuf=ctx.createBuffer(1,cLen,SR);
    const nd=nbuf.getChannelData(0); for(let i=0;i<cLen;i++) nd[i]=Math.random()*2-1;
    const noise=ctx.createBufferSource(); noise.buffer=nbuf;
    const bp=ctx.createBiquadFilter(); bp.type='bandpass'; bp.frequency.value=3100; bp.Q.value=1.3;
    const cG=ctx.createGain();
    cG.gain.setValueAtTime(vol*0.48, atTime); cG.gain.exponentialRampToValueAtTime(0.001, atTime+0.013);
    noise.connect(bp).connect(cG).connect(out); noise.start(atTime); noise.stop(atTime+0.016);

    const res=ctx.createOscillator(), rG=ctx.createGain();
    res.type='sine'; res.frequency.setValueAtTime(3700, atTime);
    rG.gain.setValueAtTime(vol*0.18, atTime); rG.gain.exponentialRampToValueAtTime(0.001, atTime+0.022);
    res.connect(rG).connect(out); res.start(atTime); res.stop(atTime+0.028);
}

function playClick(atTime, isAccent) {
    // Mechanical metronome click: sharp sine with very fast decay
    const ctx = getCtx(), out = getMetroMaster();
    const vol = isAccent ? 1.0 : 0.65, freq = isAccent ? 1200 : 900;
    const o = ctx.createOscillator(), g = ctx.createGain();
    o.type = 'square';
    o.frequency.setValueAtTime(freq, atTime);
    o.frequency.exponentialRampToValueAtTime(freq*0.5, atTime+0.018);
    g.gain.setValueAtTime(vol*0.4, atTime);
    g.gain.exponentialRampToValueAtTime(0.001, atTime+0.018);
    const lp = ctx.createBiquadFilter(); lp.type='lowpass'; lp.frequency.value=2200;
    o.connect(lp).connect(g).connect(out); o.start(atTime); o.stop(atTime+0.022);
}

function playRim(atTime, isAccent) {
    // Snare rim shot: noise filtered to midrange with sharp transient
    const ctx = getCtx(), SR = ctx.sampleRate, out = getMetroMaster();
    const vol = isAccent ? 1.0 : 0.6;
    const dur = isAccent ? 0.055 : 0.04;
    const len = Math.floor(SR * dur);
    const buf = ctx.createBuffer(1, len, SR);
    const d = buf.getChannelData(0);
    for(let i=0;i<len;i++) d[i] = (Math.random()*2-1) * Math.exp(-i/(len*0.3));
    const src = ctx.createBufferSource(); src.buffer = buf;
    const hp = ctx.createBiquadFilter(); hp.type='highpass'; hp.frequency.value = isAccent ? 900 : 700; hp.Q.value=2;
    const bp = ctx.createBiquadFilter(); bp.type='peaking'; bp.frequency.value=2500; bp.gain.value=8;
    const g = ctx.createGain(); g.gain.setValueAtTime(vol*0.9, atTime);
    src.connect(hp).connect(bp).connect(g).connect(out);
    src.start(atTime); src.stop(atTime+dur+0.01);
    // Add a ping for the accent
    if(isAccent) {
        const ping=ctx.createOscillator(), pg=ctx.createGain();
        ping.type='sine'; ping.frequency.setValueAtTime(1600, atTime);
        pg.gain.setValueAtTime(0.3, atTime); pg.gain.exponentialRampToValueAtTime(0.001, atTime+0.03);
        ping.connect(pg).connect(out); ping.start(atTime); ping.stop(atTime+0.035);
    }
}

function playCowbell(atTime, isAccent) {
    // Classic cowbell: two detuned square waves + metal resonance
    const ctx = getCtx(), out = getMetroMaster();
    const vol = isAccent ? 1.0 : 0.62;
    const dur = isAccent ? 0.28 : 0.18;
    [[562, 1], [845, 0.6]].forEach(([f, fvol]) => {
        const o=ctx.createOscillator(), g=ctx.createGain();
        o.type='square'; o.frequency.value=f;
        const bp=ctx.createBiquadFilter(); bp.type='bandpass'; bp.frequency.value=f*1.4; bp.Q.value=0.8;
        g.gain.setValueAtTime(vol*fvol*0.3, atTime);
        g.gain.exponentialRampToValueAtTime(0.001, atTime+dur);
        o.connect(bp).connect(g).connect(out); o.start(atTime); o.stop(atTime+dur+0.01);
    });
    // Metal click transient
    const o2=ctx.createOscillator(), g2=ctx.createGain();
    o2.type='triangle'; o2.frequency.setValueAtTime(3500, atTime); o2.frequency.exponentialRampToValueAtTime(1800, atTime+0.015);
    g2.gain.setValueAtTime(vol*0.5, atTime); g2.gain.exponentialRampToValueAtTime(0.001, atTime+0.015);
    o2.connect(g2).connect(out); o2.start(atTime); o2.stop(atTime+0.02);
}

function playBeat(atTime, isAccent) {
    if(clickSound==='clave')   playClave(atTime, isAccent);
    else if(clickSound==='click') playClick(atTime, isAccent);
    else if(clickSound==='rim')   playRim(atTime, isAccent);
    else if(clickSound==='cowbell') playCowbell(atTime, isAccent);
}

function playSubdiv(atTime) {
    const ctx = getCtx(), out = getMetroMaster();
    const o=ctx.createOscillator(), g=ctx.createGain();
    o.type='sine'; o.frequency.value=1900;
    g.gain.setValueAtTime(0.11, atTime);
    g.gain.exponentialRampToValueAtTime(0.001, atTime+0.02);
    o.connect(g).connect(out);
    o.start(atTime); o.stop(atTime+0.025);
}

function triggerFlash(atTime, isAccent) {
    const delay = Math.max(0, (atTime-getCtx().currentTime)*1000);
    setTimeout(() => {
        wheelEl.classList.add('beat-flash');
        metroCard.classList.add('beat-flash');
        setTimeout(() => {
            wheelEl.classList.remove('beat-flash');
            metroCard.classList.remove('beat-flash');
        }, isAccent ? 130 : 80);
    }, delay);
}

function sched() {
    const ctx = getCtx();
    while(nextBeat < ctx.currentTime+0.1) {
        const isAccent = (beatCount % timeSig === 0);
        if(metroSound) playBeat(nextBeat, isAccent);
        if(metroLight) triggerFlash(nextBeat, isAccent);
        if(subdivision > 1) {
            const step = (60/bpm)/subdivision;
            for(let s=1; s<subdivision; s++) {
                const st = nextBeat + s*step;
                if(metroSound) playSubdiv(st);
            }
        }
        beatCount++;
        nextBeat += 60/bpm;
    }
    schedTimer = setTimeout(sched, 25);
}

function updateMetroBtn() {
    const btn=document.getElementById('metroStartBtn');
    if(!btn) return;
    if(metroRunning){ btn.innerHTML='‚ñ†<br>Stop'; btn.classList.add('is-active'); }
    else { btn.innerHTML='‚ñ∂<br>Start'; btn.classList.remove('is-active'); }
}
function startMetro() {
    if(metroRunning) return;
    metroRunning=true; beatCount=0;
    nextBeat=getCtx().currentTime; sched();
    updateMetroBtn();
}
function stopMetro() {
    if(!metroRunning) return;
    metroRunning=false; clearTimeout(schedTimer);
    wheelEl.classList.remove('beat-flash');
    metroCard.classList.remove('beat-flash');
    updateMetroBtn();
}
// Restore output toggle states
if(metroSound) document.getElementById('soundToggle').classList.add('active');
if(metroLight) document.getElementById('lightToggle').classList.add('active');

document.getElementById('soundToggle').onclick = function() { metroSound=!metroSound; this.classList.toggle('active',metroSound); savePrefs(); };
document.getElementById('lightToggle').onclick = function() { metroLight=!metroLight; this.classList.toggle('active',metroLight); savePrefs(); };
document.getElementById('metroStartBtn').onclick = function() {
    if(metroRunning) { stopMetro(); }
    else { startMetro(); }
    savePrefs();
};

// Tap tempo
let tapTimes=[], tapResetTimer=null;
document.getElementById('tapBtn').onclick = () => {
    const now=performance.now();
    clearTimeout(tapResetTimer);
    if(tapTimes.length && now-tapTimes[tapTimes.length-1]>2000) tapTimes=[];
    tapTimes.push(now);
    if(tapTimes.length>=2) {
        const gaps=tapTimes.slice(1).map((t,i)=>t-tapTimes[i]);
        updateBPM(Math.round(60000/(gaps.reduce((a,b)=>a+b)/gaps.length)));
        if(metroRunning){ clearTimeout(schedTimer); beatCount=0; nextBeat=getCtx().currentTime; sched(); }
    }
    if(tapTimes.length>8) tapTimes=tapTimes.slice(-8);
    tapResetTimer=setTimeout(()=>{ tapTimes=[]; },2000);
};

// Wheel drag
(function(){
    const outer=wheelEl.parentElement;
    let dragging=false, lastAngle=0, fracBpm=0;
    const getAngle=e=>{
        const r=outer.getBoundingClientRect();
        const px=e.touches?e.touches[0].clientX:e.clientX;
        const py=e.touches?e.touches[0].clientY:e.clientY;
        return Math.atan2(py-(r.top+r.height/2), px-(r.left+r.width/2))*(180/Math.PI);
    };
    const onMove=e=>{
        if(!dragging)return;
        const angle=getAngle(e);
        let d=angle-lastAngle; lastAngle=angle;
        if(d>180)d-=360; if(d<-180)d+=360;
        fracBpm+=d/3;
        const whole=Math.trunc(fracBpm);
        if(whole!==0){ updateBPMDisplay(bpm+whole); fracBpm-=whole; }
    };
    const onEnd=()=>{
        if(!dragging)return;
        dragging=false; wheelEl.style.cursor='grab';
        fracBpm=0;
        savePrefs();
    };
    wheelEl.addEventListener('mousedown',e=>{ e.preventDefault(); dragging=true; lastAngle=getAngle(e); fracBpm=0; wheelEl.style.cursor='grabbing'; });
    window.addEventListener('mousemove',onMove);
    window.addEventListener('mouseup',onEnd);
    wheelEl.addEventListener('touchstart',e=>{ e.preventDefault(); dragging=true; lastAngle=getAngle(e); fracBpm=0; },{passive:false});
    window.addEventListener('touchmove',e=>{ if(!dragging)return; e.preventDefault(); onMove(e); },{passive:false});
    window.addEventListener('touchend',onEnd);
})();

// ‚îÄ‚îÄ‚îÄ RECORDER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let recorder, chunks=[], liveAnimFrame=null, liveAnalyser=null;

// ‚îÄ‚îÄ Pick the best supported MIME type for this browser ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// iOS Safari only supports audio/mp4; Chrome/Firefox prefer audio/webm
function getSupportedMimeType() {
    const types = ['audio/webm;codecs=opus', 'audio/webm', 'audio/mp4', 'audio/ogg;codecs=opus', ''];
    return types.find(t => !t || MediaRecorder.isTypeSupported(t)) || '';
}

function mimeToExt(mime) {
    if(mime.includes('mp4')) return 'mp4';
    if(mime.includes('ogg')) return 'ogg';
    return 'webm';
}

function drawLiveWaveform() {
    const canvas=document.getElementById('liveWaveform');
    const c2d=canvas.getContext('2d');
    canvas.width=canvas.offsetWidth;
    const buf=new Uint8Array(liveAnalyser.fftSize);
    (function draw(){
        if(!liveAnalyser) return;
        liveAnimFrame=requestAnimationFrame(draw);
        liveAnalyser.getByteTimeDomainData(buf);
        c2d.clearRect(0,0,canvas.width,canvas.height);
        c2d.strokeStyle='#22c55e'; c2d.lineWidth=2;
        c2d.beginPath();
        const sw=canvas.width/buf.length; let x=0;
        for(let i=0;i<buf.length;i++){
            const y=(buf[i]/128)*canvas.height/2;
            i===0?c2d.moveTo(x,y):c2d.lineTo(x,y); x+=sw;
        }
        c2d.lineTo(canvas.width,canvas.height/2); c2d.stroke();
    })();
}

function stopLiveWaveform() {
    if(liveAnimFrame){ cancelAnimationFrame(liveAnimFrame); liveAnimFrame=null; }
    liveAnalyser=null;
    const canvas=document.getElementById('liveWaveform');
    canvas.style.display='none';
    canvas.getContext('2d').clearRect(0,0,canvas.width,canvas.height);
}

function getAutoName() {
    const now=new Date();
    const d=now.toLocaleDateString([],{month:'short',day:'numeric'});
    const t=now.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
    return `${d} ${t}`;
}

document.getElementById('recordToggle').onclick = async function() {
    if(recorder?.state==='recording') {
        recorder.stop(); stopLiveWaveform();
        this.textContent='üéôÔ∏è Start Recording'; this.classList.remove('is-active');
        document.getElementById('rec-status').textContent='';
        return;
    }
    const stream=await navigator.mediaDevices.getUserMedia({audio:true});
    const autoName=getAutoName();
    const mimeType=getSupportedMimeType();
    const recOpts=mimeType ? {mimeType} : {};
    recorder=new MediaRecorder(stream, recOpts); chunks=[];
    recorder.ondataavailable=e=>{ if(e.data.size>0) chunks.push(e.data); };
    recorder.onstop=()=>{
        stream.getTracks().forEach(t=>t.stop());
        const actualMime=recorder.mimeType||mimeType||'audio/webm';
        const blob=new Blob(chunks,{type:actualMime});
        const item={id:Date.now().toString(), blob, mimeType:actualMime, ts:Date.now(), name:autoName};
        const tx=db.transaction('memos','readwrite');
        tx.objectStore('memos').put(item);
        tx.oncomplete=renderMemos;
    };
    // iOS: resume AudioContext before creating source (requires user gesture ‚Äî we're inside one)
    const ctx=getCtx();
    liveAnalyser=ctx.createAnalyser(); liveAnalyser.fftSize=2048;
    ctx.createMediaStreamSource(stream).connect(liveAnalyser);
    const canvas=document.getElementById('liveWaveform');
    canvas.style.display='block'; drawLiveWaveform();
    // timeslice=250ms ensures data flows on iOS (which may not fire ondataavailable without it)
    recorder.start(250);
    this.textContent='‚èπÔ∏è Stop Recording'; this.classList.add('is-active');
    document.getElementById('rec-status').textContent='‚óè Recording...';
};

function saveMemoName(m, name) {
    m.name=name.trim()||m.name;
    const tx=db.transaction('memos','readwrite');
    tx.objectStore('memos').put(m);
}

function renderMemos() {
    const list=document.getElementById('memoList'); list.innerHTML='';
    db.transaction('memos').objectStore('memos').getAll().onsuccess=e=>{
        e.target.result.sort((a,b)=>b.ts-a.ts).forEach(m=>{
            const mime=m.mimeType||(m.blob&&m.blob.type)||'audio/webm';
            const ext=mimeToExt(mime);
            // Create a correctly-typed blob URL ‚Äî critical for iOS to decode it
            const typedBlob=new Blob([m.blob],{type:mime});
            const url=URL.createObjectURL(typedBlob);
            const label=m.name||`Memo ‚Äî ${new Date(m.ts).toLocaleString()}`;
            const d=document.createElement('div'); d.className='recording-item';
            d.innerHTML=`
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">
                    <strong id="lbl-${m.id}" style="flex:1;cursor:text;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="Click to rename">${label}</strong>
                    <input id="inp-${m.id}" type="text"
                        style="display:none;flex:1;background:var(--bg);border:1px solid var(--primary);color:var(--text);border-radius:6px;padding:4px 8px;font-size:0.95rem;font-weight:700;outline:none;min-width:0;">
                    <button class="secondary" id="ren-${m.id}" style="padding:0.6rem 0.8rem;font-size:0.85rem;flex-shrink:0;min-width:44px;min-height:44px;">‚úèÔ∏è</button>
                </div>
                <div id="w-${m.id}" class="wf-box"></div>
                <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;">
                    <button class="main-action" id="p-${m.id}">‚ñ∂ Play</button>
                    <button class="secondary" id="dl-${m.id}">‚¨á Export</button>
                    <button class="secondary" onclick="deleteMemo('${m.id}')">üóë Delete</button>
                </div>`;
            list.appendChild(d);

            // Use MediaElement backend: lets the browser's native <audio> handle decoding,
            // which is the only reliable approach on iOS Safari for blob URLs.
            const ws=WaveSurfer.create({
                container:`#w-${m.id}`,
                waveColor:'#475569',
                progressColor:'#22c55e',
                backend:'MediaElement',
                url
            });
            const pb=document.getElementById(`p-${m.id}`);
            ws.on('play',()=>pb.textContent='‚è∏ Pause');
            ws.on('pause',()=>pb.textContent='‚ñ∂ Play');
            ws.on('finish',()=>pb.textContent='‚ñ∂ Play');
            // iOS: playPause must be triggered directly from user tap (already is via onclick)
            pb.onclick=()=>ws.playPause();

            document.getElementById(`dl-${m.id}`).onclick=()=>{
                const a=document.createElement('a'); a.href=url;
                a.download=`${(m.name||'memo').replace(/[^\w\s\-]/g,'_').trim()}.${ext}`;
                a.click();
            };

            const lbl=document.getElementById(`lbl-${m.id}`);
            const inp=document.getElementById(`inp-${m.id}`);
            const ren=document.getElementById(`ren-${m.id}`);
            let renaming=false;

            function enterRename() {
                renaming=true; inp.value=lbl.textContent;
                lbl.style.display='none'; inp.style.display='block';
                ren.textContent='‚úì'; inp.focus(); inp.select();
            }
            function commitRename() {
                if(!renaming) return; renaming=false;
                const n=inp.value.trim()||lbl.textContent;
                lbl.textContent=n; lbl.style.display='';
                inp.style.display='none'; ren.textContent='‚úèÔ∏è';
                saveMemoName(m,n);
            }
            ren.onclick=()=>renaming?commitRename():enterRename();
            lbl.onclick=enterRename;
            inp.onblur=()=>setTimeout(commitRename,80);
            inp.onkeydown=e=>{ if(e.key==='Enter')commitRename(); if(e.key==='Escape'){renaming=false;inp.style.display='none';lbl.style.display='';ren.textContent='‚úèÔ∏è';} };
        });
    };
}

window.deleteMemo = id => {
    if(!confirm('Delete this memo?')) return;
    const tx=db.transaction('memos','readwrite');
    tx.objectStore('memos').delete(id);
    tx.oncomplete=renderMemos;
};

// ‚îÄ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
initDB().then(()=>{
    updateBPM(bpm);
    droneSync();
    renderMemos();
});

// ‚îÄ‚îÄ‚îÄ SERVICE WORKER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
if('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/sw.js').catch(()=>{});
}

// ‚îÄ‚îÄ‚îÄ MUSIC DICTIONARY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const DICT = [
    // ‚îÄ‚îÄ TEMPO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    {t:"Grave",       l:"it", c:"Tempo", d:"Very slow and solemn (‚âà 40‚Äì50 BPM)"},
    {t:"Largo",       l:"it", c:"Tempo", d:"Broad and very slow (‚âà 40‚Äì60 BPM)"},
    {t:"Larghetto",   l:"it", c:"Tempo", d:"Slightly faster than Largo (‚âà 60‚Äì66 BPM)"},
    {t:"Lento",       l:"it", c:"Tempo", d:"Slow (‚âà 45‚Äì60 BPM)"},
    {t:"Adagio",      l:"it", c:"Tempo", d:"Slow and stately; literally 'at ease' (‚âà 66‚Äì76 BPM)"},
    {t:"Adagietto",   l:"it", c:"Tempo", d:"Slightly faster than Adagio (‚âà 70‚Äì80 BPM)"},
    {t:"Andante",     l:"it", c:"Tempo", d:"Walking pace; moderately slow (‚âà 76‚Äì108 BPM)"},
    {t:"Andantino",   l:"it", c:"Tempo", d:"Slightly faster than Andante (‚âà 80‚Äì108 BPM)"},
    {t:"Moderato",    l:"it", c:"Tempo", d:"Moderate tempo (‚âà 108‚Äì120 BPM)"},
    {t:"Allegretto",  l:"it", c:"Tempo", d:"Moderately fast; slightly slower than Allegro (‚âà 112‚Äì120 BPM)"},
    {t:"Allegro",     l:"it", c:"Tempo", d:"Fast and lively (‚âà 120‚Äì156 BPM)"},
    {t:"Allegro vivace", l:"it", c:"Tempo", d:"Fast and very lively (‚âà 144‚Äì168 BPM)"},
    {t:"Vivace",      l:"it", c:"Tempo", d:"Lively and fast (‚âà 156‚Äì176 BPM)"},
    {t:"Vivacissimo", l:"it", c:"Tempo", d:"Very fast and lively (‚âà 172‚Äì176 BPM)"},
    {t:"Presto",      l:"it", c:"Tempo", d:"Very fast (‚âà 168‚Äì200 BPM)"},
    {t:"Prestissimo", l:"it", c:"Tempo", d:"As fast as possible (‚âà 200+ BPM)"},
    {t:"Langsam",     l:"de", c:"Tempo", d:"Slow (equivalent of Lento)"},
    {t:"M√§√üig",       l:"de", c:"Tempo", d:"Moderate (equivalent of Moderato)"},
    {t:"Bewegt",      l:"de", c:"Tempo", d:"Agitated, moving; implies a brisk tempo"},
    {t:"Lebhaft",     l:"de", c:"Tempo", d:"Lively (equivalent of Vivace)"},
    {t:"Schnell",     l:"de", c:"Tempo", d:"Fast (equivalent of Allegro)"},
    {t:"Sehr schnell",l:"de", c:"Tempo", d:"Very fast (equivalent of Presto)"},
    {t:"Lent",        l:"fr", c:"Tempo", d:"Slow (equivalent of Lento)"},
    {t:"Mod√©r√©",      l:"fr", c:"Tempo", d:"Moderate tempo"},
    {t:"Vif",         l:"fr", c:"Tempo", d:"Lively, quick"},
    {t:"Vite",        l:"fr", c:"Tempo", d:"Fast"},

    // ‚îÄ‚îÄ TEMPO MODIFIERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    {t:"Accelerando", l:"it", c:"Tempo modifier", d:"Gradually speeding up (abbr. accel.)"},
    {t:"Ritardando",  l:"it", c:"Tempo modifier", d:"Gradually slowing down (abbr. rit. or ritard.)"},
    {t:"Rallentando", l:"it", c:"Tempo modifier", d:"Gradually slowing down; similar to ritardando (abbr. rall.)"},
    {t:"Ritenuto",    l:"it", c:"Tempo modifier", d:"Held back; suddenly slower (abbr. rit. or riten.)"},
    {t:"Rubato",      l:"it", c:"Tempo modifier", d:"'Robbed time'; flexible tempo for expressive phrasing"},
    {t:"A tempo",     l:"it", c:"Tempo modifier", d:"Return to the original tempo after a deviation"},
    {t:"Tempo primo", l:"it", c:"Tempo modifier", d:"Return to the first (original) tempo of the piece"},
    {t:"L'istesso tempo", l:"it", c:"Tempo modifier", d:"At the same tempo despite a meter change"},
    {t:"Stringendo",  l:"it", c:"Tempo modifier", d:"Pressing forward; increasing tension and speed"},
    {t:"Allargando",  l:"it", c:"Tempo modifier", d:"Broadening; slower and often louder"},
    {t:"Calando",     l:"it", c:"Tempo modifier", d:"Gradually slower and softer; dying away"},
    {t:"Poco a poco", l:"it", c:"Tempo modifier", d:"Little by little; applied to gradual changes"},
    {t:"Subito",      l:"it", c:"Tempo modifier", d:"Suddenly; immediately (e.g. subito piano = suddenly soft)"},

    // ‚îÄ‚îÄ DYNAMICS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    {t:"Pianissimo",  l:"it", c:"Dynamics", d:"Very soft (pp)"},
    {t:"Piano",       l:"it", c:"Dynamics", d:"Soft (p)"},
    {t:"Mezzo piano", l:"it", c:"Dynamics", d:"Moderately soft (mp)"},
    {t:"Mezzo forte", l:"it", c:"Dynamics", d:"Moderately loud (mf)"},
    {t:"Forte",       l:"it", c:"Dynamics", d:"Loud (f)"},
    {t:"Fortissimo",  l:"it", c:"Dynamics", d:"Very loud (ff)"},
    {t:"Fortepiano",  l:"it", c:"Dynamics", d:"Loud then immediately soft (fp)"},
    {t:"Sforzando",   l:"it", c:"Dynamics", d:"Sudden strong accent on a single note or chord (sfz or sf)"},
    {t:"Sforzato",    l:"it", c:"Dynamics", d:"Forced, accented; same as sforzando (sfz)"},
    {t:"Rinforzando", l:"it", c:"Dynamics", d:"Reinforced; slight sudden increase in dynamic (rfz)"},
    {t:"Crescendo",   l:"it", c:"Dynamics", d:"Gradually getting louder (cresc. or <)"},
    {t:"Decrescendo", l:"it", c:"Dynamics", d:"Gradually getting softer (decresc. or >)"},
    {t:"Diminuendo",  l:"it", c:"Dynamics", d:"Gradually getting softer; synonym of decrescendo (dim.)"},
    {t:"Morendo",     l:"it", c:"Dynamics", d:"Dying away; getting softer and slower"},
    {t:"Niente",      l:"it", c:"Dynamics", d:"Nothing; the extreme of soft, silence (n or ¬∞)"},
    {t:"Stark",       l:"de", c:"Dynamics", d:"Strong, loud"},
    {t:"Schwach",     l:"de", c:"Dynamics", d:"Weak, soft"},

    // ‚îÄ‚îÄ ARTICULATION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    {t:"Staccato",    l:"it", c:"Articulation", d:"Short and detached; notes cut off before their full value"},
    {t:"Staccatissimo",l:"it",c:"Articulation", d:"Very short and detached; even more so than staccato"},
    {t:"Legato",      l:"it", c:"Articulation", d:"Smooth and connected; notes flow into one another"},
    {t:"Tenuto",      l:"it", c:"Articulation", d:"Held for full value; sometimes implies a slight stress"},
    {t:"Marcato",     l:"it", c:"Articulation", d:"Marked; accented more than a standard accent (^)"},
    {t:"Accentato",   l:"it", c:"Articulation", d:"Accented (>)"},
    {t:"Portato",     l:"it", c:"Articulation", d:"Carried; between legato and staccato ‚Äî slightly separated"},
    {t:"Non legato",  l:"it", c:"Articulation", d:"Not legato; detached but without full staccato shortness"},
    {t:"Pizzicato",   l:"it", c:"Articulation", d:"Plucked; string players pluck instead of bowing (pizz.)"},
    {t:"Arco",        l:"it", c:"Articulation", d:"Return to bowing after pizzicato"},
    {t:"Col legno",   l:"it", c:"Articulation", d:"With the wood of the bow; tapping or bowing with the stick"},
    {t:"Sul ponticello",l:"it",c:"Articulation", d:"Bow near the bridge; produces a glassy, nasal tone"},
    {t:"Sul tasto",   l:"it", c:"Articulation", d:"Bow over the fingerboard; produces a flute-like tone"},
    {t:"Tremolo",     l:"it", c:"Articulation", d:"Rapid repetition of a single note or alternation between two notes"},
    {t:"Trillo",      l:"it", c:"Articulation", d:"Trill; rapid alternation between a note and the one above it"},
    {t:"Vibrato",     l:"it", c:"Articulation", d:"Slight fluctuation in pitch for warmth and expression"},
    {t:"Glissando",   l:"it", c:"Articulation", d:"Slide through pitches between two notes (gliss.)"},
    {t:"Portamento",  l:"it", c:"Articulation", d:"Carrying the voice/instrument smoothly between two pitches"},
    {t:"Flatterzunge",l:"de", c:"Articulation", d:"Flutter-tongue; rolling the tongue while playing a wind instrument"},
    {t:"D√©tach√©",     l:"fr", c:"Articulation", d:"Detached bowing; each note with a separate bow stroke"},
    {t:"Martel√©",     l:"fr", c:"Articulation", d:"Hammered bowing; forceful, accented separate bow strokes"},
    {t:"Spiccato",    l:"it", c:"Articulation", d:"Bouncing bow stroke; bow leaves the string between notes"},
    {t:"Sautill√©",    l:"fr", c:"Articulation", d:"Rapid spiccato where the bow bounces by itself"},
    {t:"Jet√©",        l:"fr", c:"Articulation", d:"Thrown bow stroke producing a series of bouncing notes"},

    // ‚îÄ‚îÄ EXPRESSION & CHARACTER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    {t:"Agitato",     l:"it", c:"Expression", d:"Agitated, restless"},
    {t:"Amoroso",     l:"it", c:"Expression", d:"Lovingly"},
    {t:"Animato",     l:"it", c:"Expression", d:"Animated, lively"},
    {t:"Appassionato",l:"it", c:"Expression", d:"Passionately"},
    {t:"Brillante",   l:"it", c:"Expression", d:"Brilliant, sparkling"},
    {t:"Cantabile",   l:"it", c:"Expression", d:"In a singing style"},
    {t:"Capriccioso", l:"it", c:"Expression", d:"Capricious, whimsical"},
    {t:"Comodo",      l:"it", c:"Expression", d:"Comfortable, convenient; at an easy pace"},
    {t:"Con brio",    l:"it", c:"Expression", d:"With vigor and spirit"},
    {t:"Con fuoco",   l:"it", c:"Expression", d:"With fire"},
    {t:"Con moto",    l:"it", c:"Expression", d:"With motion"},
    {t:"Con spirito", l:"it", c:"Expression", d:"With spirit"},
    {t:"Dolce",       l:"it", c:"Expression", d:"Sweetly"},
    {t:"Doloroso",    l:"it", c:"Expression", d:"Sorrowful, painful"},
    {t:"Energico",    l:"it", c:"Expression", d:"Energetically"},
    {t:"Espressivo",  l:"it", c:"Expression", d:"Expressively (espress.)"},
    {t:"Feroce",      l:"it", c:"Expression", d:"Fierce, ferocious"},
    {t:"Furioso",     l:"it", c:"Expression", d:"Furious, wild"},
    {t:"Giocoso",     l:"it", c:"Expression", d:"Playful, humorous"},
    {t:"Grandioso",   l:"it", c:"Expression", d:"Grandly, with grandeur"},
    {t:"Grazioso",    l:"it", c:"Expression", d:"Gracefully"},
    {t:"Lacrimoso",   l:"it", c:"Expression", d:"Tearful, weeping"},
    {t:"Leggiero",    l:"it", c:"Expression", d:"Light, nimble"},
    {t:"Lusigando",   l:"it", c:"Expression", d:"Coaxing, flattering; a smooth, caressing tone"},
    {t:"Maestoso",    l:"it", c:"Expression", d:"Majestic, stately"},
    {t:"Misterioso",  l:"it", c:"Expression", d:"Mysterious"},
    {t:"Nobile",      l:"it", c:"Expression", d:"Noble"},
    {t:"Pesante",     l:"it", c:"Expression", d:"Heavy, weighty"},
    {t:"Piacevole",   l:"it", c:"Expression", d:"Pleasant, pleasing"},
    {t:"Risoluto",    l:"it", c:"Expression", d:"Resolute, determined"},
    {t:"Scherzando",  l:"it", c:"Expression", d:"Playfully, jokingly"},
    {t:"Semplice",    l:"it", c:"Expression", d:"Simply, plainly"},
    {t:"Serioso",     l:"it", c:"Expression", d:"Serious"},
    {t:"Sostenuto",   l:"it", c:"Expression", d:"Sustained; held notes to their full length"},
    {t:"Tranquillo",  l:"it", c:"Expression", d:"Tranquil, calm"},
    {t:"Vivo",        l:"it", c:"Expression", d:"Lively, vivacious"},
    {t:"Zart",        l:"de", c:"Expression", d:"Tender, delicate"},
    {t:"Kr√§ftig",     l:"de", c:"Expression", d:"Vigorous, strong"},
    {t:"Innig",       l:"de", c:"Expression", d:"Heartfelt, deeply felt, intimate"},
    {t:"Feierlich",   l:"de", c:"Expression", d:"Solemn, ceremonious"},
    {t:"Flie√üend",    l:"de", c:"Expression", d:"Flowing"},
    {t:"Ruhig",       l:"de", c:"Expression", d:"Calm, peaceful"},
    {t:"Heiter",      l:"de", c:"Expression", d:"Cheerful, serene"},
    {t:"Traurig",     l:"de", c:"Expression", d:"Sad, sorrowful"},
    {t:"Leidenschaftlich",l:"de",c:"Expression",d:"Passionate, with great emotion"},
    {t:"Doux",        l:"fr", c:"Expression", d:"Sweet, soft"},
    {t:"Brillant",    l:"fr", c:"Expression", d:"Brilliant, sparkling"},
    {t:"Anim√©",       l:"fr", c:"Expression", d:"Animated, lively"},
    {t:"Expressif",   l:"fr", c:"Expression", d:"Expressive"},
    {t:"L√©ger",       l:"fr", c:"Expression", d:"Light, nimble"},
    {t:"Plaintif",    l:"fr", c:"Expression", d:"Mournful, plaintive"},

    // ‚îÄ‚îÄ FORM & STRUCTURE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    {t:"Da capo",     l:"it", c:"Form", d:"From the beginning; repeat from the start (D.C.)"},
    {t:"Dal segno",   l:"it", c:"Form", d:"From the sign; repeat from the % symbol (D.S.)"},
    {t:"Al fine",     l:"it", c:"Form", d:"To the end; used with D.C. or D.S. (play until 'Fine')"},
    {t:"Fine",        l:"it", c:"Form", d:"The end; the piece concludes here"},
    {t:"Coda",        l:"it", c:"Form", d:"Tail; a concluding passage, often marked with ‚äï"},
    {t:"Segue",       l:"it", c:"Form", d:"Continue immediately into the next section without pause"},
    {t:"Attacca",     l:"it", c:"Form", d:"Attack immediately; begin the next movement without a break"},
    {t:"Ostinato",    l:"it", c:"Form", d:"A persistently repeated rhythmic or melodic pattern"},
    {t:"Basso ostinato",l:"it",c:"Form", d:"Repeated bass pattern; also called ground bass"},
    {t:"Rondo",       l:"it", c:"Form", d:"Form with a recurring main theme (ABACADA‚Ä¶)"},
    {t:"Rondeau",     l:"fr", c:"Form", d:"French equivalent of rondo form"},
    {t:"Fugue",       l:"en", c:"Form", d:"Contrapuntal composition where a subject is introduced and developed in imitation"},
    {t:"Fuge",        l:"de", c:"Form", d:"German term for fugue"},
    {t:"Fuga",        l:"it", c:"Form", d:"Italian term for fugue"},
    {t:"Canon",       l:"en", c:"Form", d:"A melody imitated exactly by one or more voices entering at intervals"},
    {t:"Kanon",       l:"de", c:"Form", d:"German term for canon"},
    {t:"Prelude",     l:"en", c:"Form", d:"An introductory piece; also a self-contained short piece"},
    {t:"Pr√©lude",     l:"fr", c:"Form", d:"French term for prelude"},
    {t:"Preludio",    l:"it", c:"Form", d:"Italian term for prelude"},
    {t:"Nocturne",    l:"fr", c:"Form", d:"Night piece; lyrical, expressive character piece"},
    {t:"Notturno",    l:"it", c:"Form", d:"Italian term for nocturne"},
    {t:"√âtude",       l:"fr", c:"Form", d:"Study piece designed to develop a specific technique"},
    {t:"Studio",      l:"it", c:"Form", d:"Italian term for √©tude/study"},
    {t:"Sonata",      l:"it", c:"Form", d:"Multi-movement work for solo or chamber instrument"},
    {t:"Sonatina",    l:"it", c:"Form", d:"Short or simpler sonata"},
    {t:"Concerto",    l:"it", c:"Form", d:"Work for soloist(s) and orchestra"},
    {t:"Sinfonia",    l:"it", c:"Form", d:"Symphony or orchestral introduction"},
    {t:"Suite",       l:"fr", c:"Form", d:"Collection of pieces often in dance forms"},
    {t:"Partita",     l:"it", c:"Form", d:"A set of variations or a suite of dance movements"},
    {t:"Overture",    l:"en", c:"Form", d:"Orchestral introduction to an opera, oratorio, or play"},
    {t:"Ouverture",   l:"fr", c:"Form", d:"French term for overture"},
    {t:"Ouvertura",   l:"it", c:"Form", d:"Italian term for overture"},
    {t:"Aria",        l:"it", c:"Form", d:"A self-contained song for solo voice, typically in an opera"},
    {t:"Recitative",  l:"en", c:"Form", d:"Sung speech used in opera and oratorio to advance the narrative"},
    {t:"Recitativo",  l:"it", c:"Form", d:"Italian term for recitative"},
    {t:"R√©citatif",   l:"fr", c:"Form", d:"French term for recitative"},
    {t:"Theme and variations",l:"en",c:"Form",d:"A theme presented and then repeated with changes in melody, rhythm, harmony, or texture"},
    {t:"Durchf√ºhrung",l:"de", c:"Form", d:"Development section in sonata form"},
    {t:"Exposition",  l:"en", c:"Form", d:"Opening section of sonata form presenting the main themes"},
    {t:"Recapitulation",l:"en",c:"Form",d:"Final section of sonata form restating themes in the tonic"},

    // ‚îÄ‚îÄ HARMONY & THEORY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    {t:"Consonance",  l:"en", c:"Harmony", d:"Pleasing combination of notes that feels stable and resolved"},
    {t:"Dissonance",  l:"en", c:"Harmony", d:"Combination of notes that creates tension and feels unresolved"},
    {t:"Resolution",  l:"en", c:"Harmony", d:"Movement from dissonance to consonance"},
    {t:"Cadence",     l:"en", c:"Harmony", d:"Harmonic progression giving a sense of conclusion or pause"},
    {t:"Authentic cadence",l:"en",c:"Harmony",d:"V‚ÄìI (or V7‚ÄìI) progression; strong sense of resolution"},
    {t:"Plagal cadence",l:"en",c:"Harmony",d:"IV‚ÄìI progression; often called the 'Amen' cadence"},
    {t:"Half cadence", l:"en",c:"Harmony",d:"Cadence ending on V; creates expectation for continuation"},
    {t:"Deceptive cadence",l:"en",c:"Harmony",d:"V‚Äìvi (or other non-tonic) progression; avoids expected resolution"},
    {t:"Modulation",  l:"en", c:"Harmony", d:"Moving from one key to another within a piece"},
    {t:"Tonicization",l:"en", c:"Harmony", d:"Temporarily treating a chord other than tonic as a local tonic"},
    {t:"Chromaticism",l:"en", c:"Harmony", d:"Use of notes outside the diatonic scale for color and tension"},
    {t:"Diatonicism", l:"en", c:"Harmony", d:"Use of only the notes within a given major or minor scale"},
    {t:"Pedal point",  l:"en",c:"Harmony", d:"A sustained or repeated note (usually bass) while harmony changes above it"},
    {t:"Suspension",  l:"en", c:"Harmony", d:"A note held over from a previous chord creating temporary dissonance"},
    {t:"Appoggiatura",l:"it", c:"Harmony", d:"A leaning note; an ornamental note taking stress from the following main note"},
    {t:"Passing tone",l:"en", c:"Harmony", d:"Non-harmonic note that steps between two chord tones"},
    {t:"Neighbor tone",l:"en",c:"Harmony", d:"Non-harmonic note a step above or below a chord tone, returning to it"},
    {t:"Sequence",    l:"en", c:"Harmony", d:"Repetition of a pattern at a different pitch level"},
    {t:"Parallel motion",l:"en",c:"Harmony",d:"Two voices moving in the same direction by the same interval"},
    {t:"Contrary motion",l:"en",c:"Harmony",d:"Two voices moving in opposite directions"},
    {t:"Oblique motion",l:"en",c:"Harmony",d:"One voice stays on the same pitch while the other moves"},

    // ‚îÄ‚îÄ MELODY & COUNTERPOINT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    {t:"Cantus firmus",l:"it", c:"Counterpoint", d:"Fixed melody used as the basis for a contrapuntal composition"},
    {t:"Counterpoint", l:"en",c:"Counterpoint", d:"Technique of combining two or more melodic lines simultaneously"},
    {t:"Contrapuntal", l:"en",c:"Counterpoint", d:"Relating to or written in counterpoint"},
    {t:"Imitation",   l:"en", c:"Counterpoint", d:"Repetition of a melody in a different voice shortly after"},
    {t:"Inversion",   l:"en", c:"Counterpoint", d:"Turning a melody upside down ‚Äî ascending intervals become descending"},
    {t:"Retrograde",  l:"en", c:"Counterpoint", d:"Playing a melody backwards"},
    {t:"Augmentation",l:"en", c:"Counterpoint", d:"Repeating a theme with all note values lengthened (doubled)"},
    {t:"Diminution",  l:"en", c:"Counterpoint", d:"Repeating a theme with all note values shortened (halved)"},
    {t:"Stretto",     l:"it", c:"Counterpoint", d:"Overlapping imitation; new voice enters before previous one finishes"},
    {t:"Episode",     l:"en", c:"Counterpoint", d:"Passage between subject entries in a fugue"},
    {t:"Answer",      l:"en", c:"Counterpoint", d:"The second voice's entry of the subject in a fugue, typically at the fifth"},
    {t:"Subject",     l:"en", c:"Counterpoint", d:"The main theme of a fugue, introduced in a single voice"},

    // ‚îÄ‚îÄ RHYTHM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    {t:"Syncopation", l:"en", c:"Rhythm", d:"Emphasis on normally weak beats or off-beats"},
    {t:"Hemiola",     l:"en", c:"Rhythm", d:"Rhythmic shift creating the feel of 3 beats vs 2, e.g. two bars of 3/4 felt as three of 2/4"},
    {t:"Anacrusis",   l:"en", c:"Rhythm", d:"Upbeat; one or more notes before the first strong beat (also 'pickup')"},
    {t:"Downbeat",    l:"en", c:"Rhythm", d:"The first, strongest beat of a measure"},
    {t:"Upbeat",      l:"en", c:"Rhythm", d:"The last beat of a measure; leads into the next downbeat"},
    {t:"Cross-rhythm",l:"en", c:"Rhythm", d:"Simultaneous use of contrasting rhythmic patterns"},
    {t:"Polyrhythm",  l:"en", c:"Rhythm", d:"Two or more different rhythms played simultaneously"},
    {t:"Polymeter",   l:"en", c:"Rhythm", d:"Two or more different time signatures played simultaneously"},
    {t:"Compound meter",l:"en",c:"Rhythm", d:"Meter in which each beat divides into three equal parts (e.g. 6/8, 9/8)"},
    {t:"Simple meter",l:"en", c:"Rhythm", d:"Meter in which each beat divides into two equal parts (e.g. 2/4, 3/4, 4/4)"},
    {t:"Triplet",     l:"en", c:"Rhythm", d:"Three notes played in the time of two of the same value"},
    {t:"Quintuplet",  l:"en", c:"Rhythm", d:"Five notes played in the time of four (or two) of the same value"},
    {t:"Tuplet",      l:"en", c:"Rhythm", d:"Any irregular grouping of notes (triplets, quintuplets, etc.)"},
    {t:"Swing",       l:"en", c:"Rhythm", d:"Jazz feel where paired eighth notes are played long-short rather than equal"},
    {t:"Groove",      l:"en", c:"Rhythm", d:"Rhythmic feel that compels movement; quality of a rhythm section locking together"},

    // ‚îÄ‚îÄ TEXTURE & SCORING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    {t:"Monophony",   l:"en", c:"Texture", d:"Single melodic line with no accompaniment"},
    {t:"Homophony",   l:"en", c:"Texture", d:"Melody with chordal accompaniment; all voices move together"},
    {t:"Polyphony",   l:"en", c:"Texture", d:"Multiple independent melodic lines sounding simultaneously"},
    {t:"Heterophony", l:"en", c:"Texture", d:"Simultaneous variations of the same melody by different voices"},
    {t:"Unison",      l:"en", c:"Texture", d:"Two or more voices playing or singing the same pitch"},
    {t:"Octave",      l:"en", c:"Texture", d:"Interval of 12 semitones; the same note at double or half the frequency"},
    {t:"Divisi",      l:"it", c:"Texture", d:"Divided; section splits into two or more parts (div.)"},
    {t:"A due",       l:"it", c:"Texture", d:"For two; two instruments play the same part, or after divisi"},
    {t:"Tutti",       l:"it", c:"Texture", d:"All; entire ensemble plays together"},
    {t:"Soli",        l:"it", c:"Texture", d:"Plural of solo; a small group of players, not the full section"},
    {t:"Obbligato",   l:"it", c:"Texture", d:"Obligatory; an independent instrumental part essential to the piece"},
    {t:"Ad libitum",  l:"it", c:"Texture", d:"At liberty; performer may freely interpret or omit (ad lib.)"},
    {t:"Tacet",       l:"it", c:"Texture", d:"Silent; the instrument does not play for an extended passage"},

    // ‚îÄ‚îÄ NOTATION & PERFORMANCE DIRECTIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    {t:"Fermata",     l:"it", c:"Notation", d:"Hold; sustain a note or rest longer than its written value (ùÑê)"},
    {t:"Arpeggio",    l:"it", c:"Notation", d:"Notes of a chord played in rapid succession rather than simultaneously"},
    {t:"Ossia",       l:"it", c:"Notation", d:"'Or else'; an alternative, usually easier, passage"},
    {t:"Senza",       l:"it", c:"Notation", d:"Without (e.g. senza sordino = without mute)"},
    {t:"Con",         l:"it", c:"Notation", d:"With (e.g. con sordino = with mute)"},
    {t:"Sordino",     l:"it", c:"Notation", d:"Mute; device to dampen sound (sordini = plural)"},
    {t:"Sourdine",    l:"fr", c:"Notation", d:"French term for mute"},
    {t:"D√§mpfer",     l:"de", c:"Notation", d:"German term for mute"},
    {t:"Divisi",      l:"it", c:"Notation", d:"Divide the section to play separate written parts"},
    {t:"Loco",        l:"it", c:"Notation", d:"Play as written after an 8va or 8vb indication"},
    {t:"8va",         l:"it", c:"Notation", d:"Play one octave higher than written"},
    {t:"8vb",         l:"it", c:"Notation", d:"Play one octave lower than written"},
    {t:"Simile",      l:"it", c:"Notation", d:"Continue in the same manner as indicated"},
    {t:"Volta",       l:"it", c:"Notation", d:"Time; prima volta = first time, seconda volta = second time (repeat endings)"},
    {t:"Bis",         l:"it", c:"Notation", d:"Twice; repeat the marked passage"},
    {t:"Colla voce",  l:"it", c:"Notation", d:"With the voice; accompaniment follows the soloist's tempo freely"},
    {t:"Come sopra",  l:"it", c:"Notation", d:"As above; as before"},
    {t:"Senza misura",l:"it", c:"Notation", d:"Without measure; free of regular barring and meter"},
    {t:"Lunga pausa", l:"it", c:"Notation", d:"Long pause; hold the rest for an extended duration"},

    // ‚îÄ‚îÄ INTERVALS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    {t:"Unison",      l:"en", c:"Interval", d:"0 semitones; same pitch"},
    {t:"Minor 2nd",   l:"en", c:"Interval", d:"1 semitone; also called a half step or semitone"},
    {t:"Major 2nd",   l:"en", c:"Interval", d:"2 semitones; also called a whole step or whole tone"},
    {t:"Minor 3rd",   l:"en", c:"Interval", d:"3 semitones"},
    {t:"Major 3rd",   l:"en", c:"Interval", d:"4 semitones"},
    {t:"Perfect 4th", l:"en", c:"Interval", d:"5 semitones"},
    {t:"Tritone",     l:"en", c:"Interval", d:"6 semitones; augmented 4th or diminished 5th; the 'devil's interval'"},
    {t:"Perfect 5th", l:"en", c:"Interval", d:"7 semitones"},
    {t:"Minor 6th",   l:"en", c:"Interval", d:"8 semitones"},
    {t:"Major 6th",   l:"en", c:"Interval", d:"9 semitones"},
    {t:"Minor 7th",   l:"en", c:"Interval", d:"10 semitones"},
    {t:"Major 7th",   l:"en", c:"Interval", d:"11 semitones"},
    {t:"Octave",      l:"en", c:"Interval", d:"12 semitones; same note class at double frequency"},
    {t:"Diapason",    l:"fr", c:"Interval", d:"Octave; also tuning fork in French"},
    {t:"Quinte",      l:"fr", c:"Interval", d:"Fifth"},
    {t:"Quinte",      l:"de", c:"Interval", d:"Fifth (also Quinte in German)"},
    {t:"Terz",        l:"de", c:"Interval", d:"Third"},
    {t:"Sekunde",     l:"de", c:"Interval", d:"Second"},

    // ‚îÄ‚îÄ SCALES & MODES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    {t:"Major scale",  l:"en",c:"Scale/Mode", d:"W-W-H-W-W-W-H pattern; bright, happy character"},
    {t:"Minor scale (natural)",l:"en",c:"Scale/Mode",d:"W-H-W-W-H-W-W pattern; darker character"},
    {t:"Harmonic minor",l:"en",c:"Scale/Mode",d:"Natural minor with raised 7th degree; creates leading tone"},
    {t:"Melodic minor",l:"en",c:"Scale/Mode",d:"Raised 6th and 7th ascending, natural descending"},
    {t:"Dorian",      l:"en", c:"Scale/Mode", d:"Mode II: like natural minor but with raised 6th; used in folk and jazz"},
    {t:"Phrygian",    l:"en", c:"Scale/Mode", d:"Mode III: like natural minor but with lowered 2nd; Spanish/flamenco feel"},
    {t:"Lydian",      l:"en", c:"Scale/Mode", d:"Mode IV: like major but with raised 4th; dreamy, ethereal"},
    {t:"Mixolydian",  l:"en", c:"Scale/Mode", d:"Mode V: like major but with lowered 7th; rock and folk common"},
    {t:"Aeolian",     l:"en", c:"Scale/Mode", d:"Mode VI: natural minor scale"},
    {t:"Locrian",     l:"en", c:"Scale/Mode", d:"Mode VII: diminished feel; rarely used as a tonal center"},
    {t:"Pentatonic",  l:"en", c:"Scale/Mode", d:"5-note scale; major pentatonic (1-2-3-5-6) or minor pentatonic (1-b3-4-5-b7)"},
    {t:"Blues scale",  l:"en",c:"Scale/Mode", d:"Minor pentatonic plus a flattened 5th (the 'blue note')"},
    {t:"Whole tone",  l:"en", c:"Scale/Mode", d:"Scale of 6 notes all a whole step apart; creates ambiguous, dreamlike sound"},
    {t:"Chromatic scale",l:"en",c:"Scale/Mode",d:"12-note scale using every semitone"},
    {t:"Octatonic",   l:"en", c:"Scale/Mode", d:"8-note scale alternating whole and half steps; also called diminished scale"},
    {t:"Ganztonleiter",l:"de",c:"Scale/Mode", d:"Whole-tone scale"},
    {t:"Gamme",       l:"fr", c:"Scale/Mode", d:"Scale"},
    {t:"Tonleiter",   l:"de", c:"Scale/Mode", d:"Scale (literally 'tone ladder')"},

    // ‚îÄ‚îÄ CHORDS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    {t:"Triad",       l:"en", c:"Chords", d:"Three-note chord; root, third, and fifth"},
    {t:"Major triad", l:"en", c:"Chords", d:"Root, major 3rd, perfect 5th; bright sound"},
    {t:"Minor triad", l:"en", c:"Chords", d:"Root, minor 3rd, perfect 5th; darker sound"},
    {t:"Diminished triad",l:"en",c:"Chords",d:"Root, minor 3rd, diminished 5th; tense, unstable"},
    {t:"Augmented triad",l:"en",c:"Chords",d:"Root, major 3rd, augmented 5th; dreamy, unstable"},
    {t:"Seventh chord",l:"en",c:"Chords", d:"Triad plus a seventh; adds color and tension"},
    {t:"Dominant 7th",l:"en", c:"Chords", d:"Major triad + minor 7th; strong pull toward tonic (V7)"},
    {t:"Major 7th",   l:"en", c:"Chords", d:"Major triad + major 7th; jazz-influenced, lush"},
    {t:"Minor 7th",   l:"en", c:"Chords", d:"Minor triad + minor 7th; smooth, common in jazz"},
    {t:"Half-diminished",l:"en",c:"Chords",d:"Diminished triad + minor 7th (√∏); used in ii chord of minor keys"},
    {t:"Fully diminished",l:"en",c:"Chords",d:"Diminished triad + diminished 7th (¬∞7); symmetric, ambiguous"},
    {t:"Suspended chord",l:"en",c:"Chords",d:"3rd replaced by 2nd (sus2) or 4th (sus4); open, unresolved sound"},
    {t:"Added chord",  l:"en",c:"Chords", d:"Chord with an added note not part of the basic 7th structure (e.g. add9)"},
    {t:"Slash chord",  l:"en",c:"Chords", d:"Chord with a specified bass note other than the root (e.g. C/E)"},
    {t:"Polychord",   l:"en", c:"Chords", d:"Two distinct chords played simultaneously"},
    {t:"Cluster",     l:"en", c:"Chords", d:"Group of adjacent notes (semitones or tones) played together"},

    // ‚îÄ‚îÄ VOICE & INSTRUMENT TYPES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    {t:"Soprano",     l:"it", c:"Voice type", d:"Highest female voice range"},
    {t:"Mezzo-soprano",l:"it",c:"Voice type", d:"Middle female voice, lower than soprano"},
    {t:"Contralto",   l:"it", c:"Voice type", d:"Lowest female voice range"},
    {t:"Alto",        l:"it", c:"Voice type", d:"Lower female voice; also a range in choral writing"},
    {t:"Tenor",       l:"it", c:"Voice type", d:"Highest standard male voice range"},
    {t:"Baritone",    l:"it", c:"Voice type", d:"Middle male voice between tenor and bass"},
    {t:"Bass",        l:"en", c:"Voice type", d:"Lowest male voice range"},
    {t:"Basso profondo",l:"it",c:"Voice type",d:"Exceptionally deep bass voice"},
    {t:"Falsetto",    l:"it", c:"Voice type", d:"Upper register of the voice above modal range; light, flute-like quality"},
    {t:"Voix de t√™te",l:"fr", c:"Voice type", d:"Head voice; upper resonance register"},
    {t:"Voix de poitrine",l:"fr",c:"Voice type",d:"Chest voice; lower, fuller vocal register"},

    // ‚îÄ‚îÄ MUSIC THEORY CONCEPTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    {t:"Tonic",       l:"en", c:"Theory", d:"The first degree of a scale; the home pitch (I)"},
    {t:"Supertonic",  l:"en", c:"Theory", d:"The second degree of a scale (II)"},
    {t:"Mediant",     l:"en", c:"Theory", d:"The third degree of a scale (III)"},
    {t:"Subdominant", l:"en", c:"Theory", d:"The fourth degree of a scale (IV)"},
    {t:"Dominant",    l:"en", c:"Theory", d:"The fifth degree of a scale; strong pull back to tonic (V)"},
    {t:"Submediant",  l:"en", c:"Theory", d:"The sixth degree of a scale (VI)"},
    {t:"Leading tone",l:"en", c:"Theory", d:"The seventh degree; a half step below tonic, strongly pulls upward (VII)"},
    {t:"Subtonic",    l:"en", c:"Theory", d:"The seventh degree a whole step below tonic; weaker pull than leading tone"},
    {t:"Enharmonic",  l:"en", c:"Theory", d:"Same pitch, different name (e.g. C# and Db)"},
    {t:"Transposition",l:"en",c:"Theory", d:"Moving all notes of a piece up or down by a constant interval"},
    {t:"Intonation",  l:"en", c:"Theory", d:"Accuracy of pitch; playing or singing in tune"},
    {t:"Temperament", l:"en", c:"Theory", d:"System for tuning intervals; equal temperament divides the octave into 12 equal semitones"},
    {t:"Just intonation",l:"en",c:"Theory",d:"Tuning based on pure frequency ratios; sounds more natural but not modulation-friendly"},
    {t:"Circle of fifths",l:"en",c:"Theory",d:"Diagram showing all 12 major (and minor) keys arranged by perfect fifth relationships"},
    {t:"Relative key",l:"en", c:"Theory", d:"Major and minor keys sharing the same key signature (e.g. C major / A minor)"},
    {t:"Parallel key",l:"en", c:"Theory", d:"Major and minor keys sharing the same tonic (e.g. C major / C minor)"},
    {t:"Key signature",l:"en",c:"Theory", d:"Sharps or flats at the start of a staff indicating the key"},
    {t:"Time signature",l:"en",c:"Theory",d:"Fraction indicating beats per measure (top) and beat note value (bottom)"},
    {t:"Pitch class", l:"en", c:"Theory", d:"A note regardless of octave; all Cs are the same pitch class"},
    {t:"Register",    l:"en", c:"Theory", d:"The particular octave range of a pitch or voice"},
    {t:"Tessitura",   l:"it", c:"Theory", d:"The range most natural and comfortable for a voice or instrument"},
    {t:"Ambitus",     l:"it", c:"Theory", d:"The full range of pitches in a piece or voice part"},

    // ‚îÄ‚îÄ ORNAMENTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    {t:"Trill",       l:"en", c:"Ornament", d:"Rapid alternation between a note and the semitone or whole tone above it"},
    {t:"Mordent",     l:"en", c:"Ornament", d:"Quick oscillation: note, lower neighbor, note (lower mordent) or note, upper neighbor, note (upper mordent/inverted)"},
    {t:"Pralltriller",l:"de", c:"Ornament", d:"Upper mordent; rapid note-upper neighbor-note figure"},
    {t:"Turn",        l:"en", c:"Ornament", d:"Four-note ornament: upper neighbor, main note, lower neighbor, main note"},
    {t:"Gruppetto",   l:"it", c:"Ornament", d:"Italian term for turn ornament"},
    {t:"Grace note",  l:"en", c:"Ornament", d:"Small decorative note before the main note; acciaccatura or appoggiatura"},
    {t:"Acciaccatura",l:"it", c:"Ornament", d:"Crushed note; a grace note played almost simultaneously with the main note (‚ô™ with stroke)"},
    {t:"Appoggiatura",l:"it", c:"Ornament", d:"Leaning grace note; takes half the value of the following note"},
    {t:"Cadenza",     l:"it", c:"Ornament", d:"Virtuosic solo passage, often improvised, near the end of a concerto movement"},
];

(function(){
    const searchEl = document.getElementById('dictSearch');
    const resultsEl = document.getElementById('dictResults');
    const countEl = document.getElementById('dictCount');
    const langFilter = document.getElementById('dictLangFilter');

    const LANG_LABELS = {it:'Italian', de:'German', fr:'French', en:'English'};
    const CATEGORY_COLORS = {
        'Tempo':'#3b82f6','Tempo modifier':'#6366f1','Dynamics':'#f59e0b',
        'Articulation':'#10b981','Expression':'#ec4899','Form':'#8b5cf6',
        'Harmony':'#ef4444','Counterpoint':'#14b8a6','Rhythm':'#f97316',
        'Texture':'#06b6d4','Notation':'#84cc16','Interval':'#a78bfa',
        'Scale/Mode':'#22d3ee','Chords':'#fb923c','Voice type':'#f472b6',
        'Theory':'#60a5fa','Ornament':'#34d399'
    };

    let activeLang = 'all';

    langFilter.addEventListener('click', e => {
        if(e.target.tagName !== 'BUTTON') return;
        langFilter.querySelectorAll('button').forEach(b => b.classList.remove('active'));
        e.target.classList.add('active');
        activeLang = e.target.dataset.lang;
        render();
    });

    function highlight(text, query) {
        if(!query) return text;
        const escaped = query.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');
        return text.replace(new RegExp(`(${escaped})`, 'gi'),
            '<mark style="background:rgba(34,197,94,0.3);color:inherit;border-radius:2px;">$1</mark>');
    }

    function render() {
        const q = searchEl.value.trim().toLowerCase();
        const filtered = DICT.filter(entry => {
            if(activeLang !== 'all' && entry.l !== activeLang) return false;
            if(!q) return true;
            return entry.t.toLowerCase().includes(q)
                || entry.d.toLowerCase().includes(q)
                || entry.c.toLowerCase().includes(q)
                || LANG_LABELS[entry.l].toLowerCase().includes(q);
        });

        if(filtered.length === 0) {
            resultsEl.innerHTML = '<div style="color:var(--text-muted);text-align:center;padding:2rem;">No terms found.</div>';
            countEl.textContent = '';
            return;
        }

        resultsEl.innerHTML = filtered.map(entry => {
            const color = CATEGORY_COLORS[entry.c] || 'var(--primary)';
            const langLabel = LANG_LABELS[entry.l] || entry.l;
            const ht = highlight(entry.t, q);
            const hd = highlight(entry.d, q);
            return `<div style="background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:0.75rem 1rem;display:flex;flex-direction:column;gap:3px;">
                <div style="display:flex;align-items:baseline;gap:8px;flex-wrap:wrap;">
                    <span style="font-weight:800;font-size:1rem;">${ht}</span>
                    <span style="font-size:0.68rem;font-weight:700;color:${color};background:${color}22;padding:1px 7px;border-radius:99px;white-space:nowrap;">${entry.c}</span>
                    <span style="font-size:0.68rem;color:var(--text-muted);margin-left:auto;white-space:nowrap;">${langLabel}</span>
                </div>
                <div style="font-size:0.85rem;color:var(--text-muted);line-height:1.5;">${hd}</div>
            </div>`;
        }).join('');

        countEl.textContent = `${filtered.length} of ${DICT.length} terms`;
    }

    let debounceTimer;
    searchEl.addEventListener('input', () => {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(render, 120);
    });

    render();
})();

</body>
</html>
