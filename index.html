<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Musician's Practice Toolkit</title>
    <script src="https://unpkg.com/wavesurfer.js@7"></script>
    <style>
        :root {
            --primary: #22c55e;
            --danger: #ef4444;
            --bg: #0f172a;
            --surface: #1e293b;
            --border: #334155;
            --text: #f1f5f9;
            --text-muted: #94a3b8;
        }
        *, *::before, *::after { box-sizing: border-box; }
        body { font-family: system-ui,-apple-system,sans-serif; background: var(--bg); color: var(--text); max-width: 860px; margin: 0 auto; padding: 1.5rem; line-height: 1.5; }
        h1 { text-align: center; margin: 0 0 1.5rem; font-weight: 800; font-size: clamp(1.3rem,5vw,2rem); }
        h2 { margin: 0 0 1.2rem; color: var(--text-muted); font-size: 0.78rem; text-transform: uppercase; letter-spacing: 1.5px; }

        .card { background: var(--surface); border: 2px solid var(--border); border-radius: 16px; padding: 1.5rem; margin-bottom: 1.5rem; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.4); transition: border-color 0.06s ease-out, box-shadow 0.06s ease-out; }
        .card.beat-flash { border-color: var(--primary) !important; box-shadow: 0 0 0 4px rgba(34,197,94,0.28), 0 10px 25px -5px rgba(0,0,0,0.4) !important; }


        /* DRONE */
        .drone-section { display: flex; flex-direction: column; gap: 1.2rem; }
        .selector-label { display: block; font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 0.4rem; font-weight: 700; }
        .root-grid { display: grid; grid-template-columns: repeat(6,1fr); gap: 5px; }
        .interval-grid { display: grid; grid-template-columns: repeat(auto-fill,minmax(56px,1fr)); gap: 5px; }
        .btn-toggle { background: var(--bg); border: 1px solid var(--border); color: var(--text); padding: 12px 3px; border-radius: 6px; cursor: pointer; font-size: 0.8rem; font-weight: 600; transition: all 0.15s; touch-action: manipulation; min-height: 44px; }
        .btn-toggle:hover:not(.active) { border-color: var(--primary); color: var(--primary); }
        .btn-toggle:active { opacity: 0.75; }
        .btn-toggle.active { background: var(--primary); border-color: var(--primary); color: #fff; }

        .settings-bar { display: flex; flex-wrap: wrap; gap: 10px; padding: 1rem; background: rgba(0,0,0,0.3); border-radius: 12px; align-items: center; justify-content: center; border: 1px solid var(--border); }
        .control-group { display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .switch-ui { display: flex; background: var(--bg); border-radius: 8px; padding: 3px; border: 1px solid var(--border); }
        .switch-ui button { background: transparent; color: var(--text-muted); border: none; padding: 10px 12px; font-size: 0.68rem; border-radius: 5px; cursor: pointer; font-weight: 700; min-height: 44px; touch-action: manipulation; transition: all 0.15s; }
        .switch-ui button:active { opacity: 0.75; }
        .switch-ui button.active { background: var(--primary); color: #fff; }

        .vol-row { display: flex; align-items: center; gap: 8px; width: 100%; }
        .vol-row input[type=range] { flex: 1; }
        input[type=range] { accent-color: var(--primary); cursor: pointer; width: 88px; height: 20px; }
        input[type=range]::-webkit-slider-thumb { width: 28px; height: 28px; }
        input[type=range]::-moz-range-thumb { width: 28px; height: 28px; border-radius: 50%; background: var(--primary); border: none; }

        #debug-console { background: #000; color: var(--primary); font-family: 'Courier New',monospace; font-size: 0.72rem; padding: 10px; border-radius: 8px; margin-top: 0.5rem; min-height: 65px; border: 1px solid #166534; white-space: pre-wrap; }
        .details-btn { background: none; border: none; color: var(--text-muted); font-size: 0.73rem; cursor: pointer; padding: 3px 0; text-decoration: underline; }

        /* METRONOME */
        .metro-layout { display: flex; flex-wrap: wrap; gap: 1.5rem; align-items: flex-start; justify-content: center; }
        .wheel-col { display: flex; flex-direction: column; align-items: center; gap: 0.75rem; }
        .wheel-outer { position: relative; width: 200px; height: 200px; user-select: none; touch-action: none; }
        #wheel { width: 100%; height: 100%; border-radius: 50%; background: radial-gradient(circle,#1e293b 30%,#0f172a 100%); border: 12px solid var(--border); cursor: grab; transition: border-color 0.06s, box-shadow 0.06s; }
        #wheel.beat-flash { border-color: var(--primary); box-shadow: 0 0 22px rgba(34,197,94,0.5); }
        #wheel::after { content:''; position: absolute; top: 11px; left: 50%; transform: translateX(-50%); width: 12px; height: 12px; background: var(--primary); border-radius: 50%; }
        .bpm-container { position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); text-align: center; width: 130px; pointer-events: none; z-index: 2; }
        #bpm-display { font-size: 3.2rem; font-weight: 900; color: var(--text); cursor: pointer; line-height: 1; pointer-events: auto; }
        #bpm-input { width: 100%; background: transparent; border: none; color: var(--primary); font-size: 3.2rem; font-weight: 900; text-align: center; display: none; outline: none; pointer-events: auto; }
        #bpm-label { font-size: 0.62rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-top: 2px; }
        .bpm-adj { display: flex; align-items: center; gap: 8px; }
        .adj-btn { background: var(--bg); border: 1px solid var(--border); color: var(--text); width: 44px; height: 44px; border-radius: 50%; font-size: 1.2rem; cursor: pointer; font-weight: 700; display: flex; align-items: center; justify-content: center; transition: all 0.15s; touch-action: manipulation; }
        .adj-btn:hover { border-color: var(--primary); color: var(--primary); }
        .adj-btn:active { background: var(--primary); border-color: var(--primary); color: #fff; }

        .wheel-row { display: flex; flex-direction: column; align-items: center; gap: 0.75rem; }
        .wheel-and-adj { display: flex; flex-direction: column; align-items: center; gap: 0.75rem; }
        .start-tap-col { display: flex; flex-direction: row; gap: 0.5rem; width: 200px; }
        .metro-start-btn { flex: 2; font-size: 1.4rem; line-height: 1.4; border-radius: 14px; padding: 0.9rem 0.5rem; text-align: center; }
        .metro-tap-btn { flex: 1; font-size: 0.85rem; line-height: 1.4; text-align: center; padding: 0.5rem; border-radius: 10px; }
        .metro-controls { display: flex; flex-direction: column; gap: 1rem; flex: 1; min-width: 205px; }
        .seg-ctrl { display: flex; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; overflow: hidden; }
        .seg-ctrl button { flex: 1; background: transparent; color: var(--text-muted); border: none; border-right: 1px solid var(--border); padding: 12px 2px; font-size: 0.7rem; font-weight: 700; cursor: pointer; transition: all 0.15s; touch-action: manipulation; min-height: 44px; }
        .seg-ctrl button:last-child { border-right: none; }
        .seg-ctrl button:active { opacity: 0.75; }
        .seg-ctrl button.active { background: var(--primary); color: #fff; }
        .mode-row { display: flex; gap: 8px; }

        /* RECORDER */
        .recording-item { background: var(--surface); border: 1px solid var(--border); padding: 1.2rem; margin-bottom: 1rem; border-radius: 14px; }
        .wf-box { height: 88px; background: rgba(0,0,0,0.5); border-radius: 8px; margin: 12px 0; overflow: hidden; }

        /* BUTTONS */
        button.main-action { background: var(--primary); color: #fff; border: none; padding: 0.7rem 1.4rem; border-radius: 10px; font-weight: 700; cursor: pointer; font-size: 0.92rem; touch-action: manipulation; transition: filter 0.15s; min-height: 44px; }
        button.main-action:hover { filter: brightness(1.1); }
        button.main-action:active { filter: brightness(0.9); }
        button.main-action.is-active { background: var(--danger); }
        button.secondary { background: var(--border); color: var(--text); padding: 0.7rem 1.3rem; border-radius: 10px; font-weight: 700; cursor: pointer; border: 1px solid transparent; font-size: 0.92rem; touch-action: manipulation; transition: all 0.15s; min-height: 44px; }
        button.secondary:hover { border-color: var(--primary); }
        button.secondary:active { border-color: var(--primary); filter: brightness(1.15); }
        .num-input { background: var(--bg); border: 1px solid var(--border); color: var(--primary); padding: 5px; border-radius: 4px; width: 52px; text-align: center; font-weight: 700; }
        .stepper { display: flex; align-items: center; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; overflow: hidden; }
        .stepper-btn { background: transparent; border: none; color: var(--text); font-size: 1.1rem; font-weight: 700; cursor: pointer; width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; touch-action: manipulation; transition: background 0.1s; flex-shrink: 0; }
        .stepper-btn:hover { background: var(--border); }
        .stepper-btn:active { background: var(--primary); color: #fff; }
        .stepper-val { color: var(--primary); font-weight: 700; font-size: 0.9rem; min-width: 40px; text-align: center; padding: 0 2px; }

        /* RESPONSIVE */
        @media (max-width: 500px) {
            body { padding: 1rem 0.75rem; }
            .btn-toggle { font-size: 0.72rem; padding: 12px 1px; }
            .wheel-outer { width: 170px; height: 170px; }
            #bpm-display { font-size: 2.8rem; }
            .settings-bar { gap: 7px; padding: 0.75rem; }
            button.main-action, button.secondary { padding: 0.6rem 1rem; font-size: 0.85rem; }
            .metro-controls { min-width: unset; width: 100%; }
            .seg-ctrl button { font-size: 0.62rem; padding: 12px 2px; }
            .wheel-row { flex-direction: row; align-items: flex-start; }
            .wheel-and-adj { flex: 1; align-items: center; }
            .start-tap-col { flex-direction: column; width: auto; align-self: stretch; order: -1; flex: 0 0 96px; }
            .metro-start-btn { flex: 2; height: auto; font-size: 1.6rem; padding: 0.5rem; }
            .metro-tap-btn { flex: 1; font-size: 1rem; }
            #metro-vol-row { order: -1; }
        }
    </style>
</head>
<body>

<h1>üéµ Musician's Practice Toolkit</h1>


<!-- DRONE -->
<div class="card">
    <h2>Drone Machine</h2>
    <div class="drone-section">
        <div>
            <span class="selector-label">1. Root Note</span>
            <div class="root-grid" id="rootGrid"></div>
        </div>
        <div>
            <span class="selector-label">2. Chord Intervals</span>
            <div class="interval-grid" id="intervalGrid"></div>
        </div>
        <div class="settings-bar">
            <div class="control-group">
                <span class="selector-label">A Ref</span>
                <div class="stepper">
                    <button class="stepper-btn" id="droneRefMinus">‚àí</button>
                    <span class="stepper-val" id="droneRefVal">440</span>
                    <button class="stepper-btn" id="droneRefPlus">+</button>
                </div>
                <input type="hidden" id="droneRef" value="440">
            </div>
            <div class="control-group">
                <span class="selector-label">Octave</span>
                <div class="stepper">
                    <button class="stepper-btn" id="droneOctaveMinus">‚àí</button>
                    <span class="stepper-val" id="droneOctaveVal">4</span>
                    <button class="stepper-btn" id="droneOctavePlus">+</button>
                </div>
                <input type="hidden" id="droneOctave" value="4" min="1" max="6">
            </div>
            <div class="control-group" style="flex:1;min-width:140px;">
                <span class="selector-label">Volume</span>
                <div class="vol-row"><span style="font-size:0.85rem;">üîà</span><input type="range" id="droneVolume" min="0" max="1" step="0.05" value="0.7"><span style="font-size:0.85rem;">üîä</span></div>
            </div>
            <div class="control-group"><span class="selector-label">Tuning</span>
                <div class="switch-ui" id="tuningSwitch">
                    <button data-val="just" class="active">JUST</button>
                    <button data-val="equal">ET</button>
                </div>
            </div>
            <div class="control-group"><span class="selector-label">Wave</span>
                <div class="switch-ui" id="colorSwitch">
                    <button data-val="sine" class="active">SINE</button>
                    <button data-val="triangle">TRI</button>
                </div>
            </div>
            <div style="display:flex;gap:8px;">
                <button id="droneToggle" class="main-action">üéµ Start Drone</button>
                <button id="droneClear" class="secondary">üßπ Clear</button>
            </div>
        </div>
        <div>
            <button class="details-btn" id="detailsToggle">üî¨ Show Details</button>
            <div id="debug-console" style="display:none;"></div>
        </div>
    </div>
</div>

<!-- METRONOME -->
<div class="card" id="metro-card">
    <h2>Metronome</h2>
    <div class="metro-layout">
        <div class="wheel-col">
            <div class="wheel-row">
                <div class="wheel-and-adj">
                    <div class="wheel-outer">
                        <div class="bpm-container">
                            <div id="bpm-display">120</div>
                            <input type="number" id="bpm-input" min="40" max="280" inputmode="numeric">
                            <div id="bpm-label">BPM</div>
                        </div>
                        <div id="wheel"></div>
                    </div>
                    <div class="bpm-adj">
                        <button class="adj-btn" id="bpmMinus">‚àí</button>
                        <span style="font-size:0.68rem;color:var(--text-muted);">fine adjust</span>
                        <button class="adj-btn" id="bpmPlus">+</button>
                    </div>
                </div>
                <div class="start-tap-col">
                    <button id="metroStartBtn" class="main-action metro-start-btn">‚ñ∂<br>Start</button>
                    <button id="tapBtn" class="secondary metro-tap-btn">üëÜ<br>Tap</button>
                </div>
            </div>
        </div>
        <div class="metro-controls">
            <div>
                <span class="selector-label">Time Signature</span>
                <div class="seg-ctrl" id="timeSigCtrl">
                    <button data-val="2">2/4</button>
                    <button data-val="3">3/4</button>
                    <button data-val="4" class="active">4/4</button>
                    <button data-val="6">6/8</button>
                </div>
            </div>
            <div>
                <span class="selector-label">Subdivision</span>
                <div class="seg-ctrl" id="subdivCtrl">
                    <button data-val="1" class="active">‚ô© Beat</button>
                    <button data-val="2">‚ô™ 8th</button>
                    <button data-val="3">‚ô©¬≥ Trip</button>
                    <button data-val="4">‚ô¨ 16th</button>
                </div>
            </div>
            <div>
                <span class="selector-label">Click Sound</span>
                <div class="seg-ctrl" id="clickSoundCtrl">
                    <button data-val="clave" class="active">Clave</button>
                    <button data-val="click">Click</button>
                    <button data-val="rim">Rim</button>
                    <button data-val="cowbell">Cowbell</button>
                </div>
            </div>
            <div id="metro-vol-row">
                <span class="selector-label">Volume</span>
                <div class="vol-row"><span style="font-size:0.85rem;">üîá</span><input type="range" id="metroVolume" min="0" max="1" step="0.05" value="0.7"><span style="font-size:0.85rem;">üîä</span></div>
            </div>
            <div>
                <span class="selector-label">Output</span>
                <div class="mode-row">
                    <button id="soundToggle" class="btn-toggle" style="flex:1;">üîî Sound</button>
                    <button id="lightToggle" class="btn-toggle" style="flex:1;">‚ö° Light</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- AUDIO MEMOS -->
<div class="card">
    <h2>Audio Memos</h2>
    <div style="text-align:center;">
        <button id="recordToggle" class="main-action">üéôÔ∏è Start Recording</button>
    </div>
    <div id="rec-status" style="margin-top:0.75rem;height:20px;color:var(--primary);font-weight:700;font-size:0.8rem;text-align:center;"></div>
    <canvas id="liveWaveform" height="80" style="width:100%;display:none;border-radius:8px;background:rgba(0,0,0,0.5);margin-top:0.75rem;"></canvas>
</div>

<div id="memoList"></div>

<script type="module">

// 1. Inline the base64 string directly (No import needed!)
const silenceDataURI = "data:audio/mpeg;base64,//uQxAAAAAAAAAAAAAAAAAAAAAAASW5mbwAAAA8AAAADAAAGhgBVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVWqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqr///////////////////////////////////////////8AAAA5TEFNRTMuOThyAc0AAAAAAAAAABSAJAiqQgAAgAAABobxtI73AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//uQxAACFEII9ACZ/sJZwWEoEb8w/////N//////JcxjHjf+7/v/H2PzCCFAiDtGeyBCIx7bJJ1mmEEMy6g8mm2c8nrGABB4h2Mkmn//4z/73u773R5qHHu/j/w7Kxkzh5lWRWdsifCkNAnY9Zc1HvDAhjhSHdFkHFzLmabt/AQxSg2wwzLhHIJOBnAWwVY4zrhIYhhc2kvhYDfQ4hDi2Gmh5KyFn8EcGIrHAngNgIwVIEMf5bzbAiTRoAD///8z/KVhkkWEle6IX+d/z4fvH3BShK1e5kmjkCMoxVmXhd4ROlTKo3iipasvTilY21q19ta30/v/0/idPX1v8PNxJL6ramnOVsdvMv2akO0iSYIzdJFirtzWXCZicS9vHqvSKyqm5XJBdqBwPxyfJdykhWTZ0G0ZyTZGpLKxsNwwoRhsx3tZfhwmeOBVISm3impAC/IT/8hP/EKEM1KMdVdVKM2rHV4x7HVXZvbVVKN/qq8CiV9VL9jjH/6l6qf7MBCjZmOqsAibjcP+qqqv0oxqpa/NVW286hPo1nz2L/h8+jXt//uSxCmDU2IK/ECN98KKtE5IYzNoCfbw+u9i5r8PoadUMFPKqWL4LK3T/LCraMSHGkW4bpLXR/E6LlHOVQxmslKVJ8IULktMN06N0FKCpHCoYsjC4F+Z0NVqdNFoGSTjSiyjzLdnZ2fNqTi2eHKONONKLMPMKLONKLMPQRJGlFxZRoKcJFAYEeIFiRQkUWUeYfef//Ko04soswso40UJAgMw8wosososy0EalnZyjQUGBRQGIFggOWUacWUeYmuadrZziQKKEgQsQLAhQkUJAgMQDghltLO1onp0cpkNInSFMqlYeSEJ5AHsqFdOwy1DA2sRmRJKxdKRfLhfLw5BzUxBTUUzLjk4LjJVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVUxBTUUzLjk4LjJVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVf/7ksRRA8AAAaQAAAAgAAA0gAAABFVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVU=";

// 2. Setup the audio tag
const audioTag = document.createElement("audio");
audioTag.controls = false;
audioTag.preload = "auto";
audioTag.loop = true; // looping is usually fine here, but we'll pause it right away
audioTag.src = silenceDataURI;

// 3. Unlock audio on the FIRST user interaction
let isAudioUnlocked = false;

const unlockAudio = () => {
    if (isAudioUnlocked) return;
    
    // Play the silent audio file to bypass the mute switch
    audioTag.play().then(() => {
        // As soon as it plays, we can pause it. The session is now unlocked.
        audioTag.pause();
        isAudioUnlocked = true;
        
        // Remove the event listeners to keep things clean
        document.removeEventListener('touchstart', unlockAudio);
        document.removeEventListener('click', unlockAudio);
    }).catch(err => {
        // If it fails (e.g., browser policies), we'll just quietly ignore it
        console.warn("Audio unlock failed:", err);
    });
};

// Bind to both touch and click to ensure we catch the user's first action
document.addEventListener('touchstart', unlockAudio, { once: true });
document.addEventListener('click', unlockAudio, { once: true });

// ‚îÄ‚îÄ‚îÄ AUDIO CONTEXT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let audioCtx, db;
const getCtx = () => {
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    if (audioCtx.state === 'suspended') audioCtx.resume();
    return audioCtx;
};

// ‚îÄ‚îÄ‚îÄ PERSISTENCE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const PREFS_KEY = 'toolkit_prefs_v1';
function loadPrefs() { try { return JSON.parse(localStorage.getItem(PREFS_KEY)) || {}; } catch { return {}; } }
function savePrefs() {
    try {
        localStorage.setItem(PREFS_KEY, JSON.stringify({
            bpm, timeSig, subdivision, metroSound, metroLight,
            metroVolume, clickSound,
            droneRoot: droneState.root,
            droneIntervals: [...droneState.intervals],
            droneTuning: droneState.tuning,
            droneColor: droneState.color,
            droneOctave: droneState.octave,
            droneVolume: droneState.volume,
            droneRef: parseFloat(document.getElementById('droneRef').value) || 440
        }));
    } catch(e) {}
}

// ‚îÄ‚îÄ‚îÄ INDEXEDDB ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const initDB = () => new Promise(res => {
    const req = indexedDB.open('MusiciansToolkit', 1);
    req.onupgradeneeded = e => e.target.result.createObjectStore('memos', { keyPath: 'id' });
    req.onsuccess = e => { db = e.target.result; res(); };
});

// ‚îÄ‚îÄ‚îÄ DRONE DATA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const noteNames = ["C","C#","D","Eb","E","F","F#","G","Ab","A","Bb","B"];
const droneRatios = [
    {n:"Uni",s:0, r:1,      f:"1/1"},   {n:"m2", s:1,  r:16/15, f:"16/15"},
    {n:"M2", s:2, r:9/8,    f:"9/8"},   {n:"m3", s:3,  r:6/5,   f:"6/5"},
    {n:"M3", s:4, r:5/4,    f:"5/4"},   {n:"P4", s:5,  r:4/3,   f:"4/3"},
    {n:"TT", s:6, r:7/5,    f:"7/5"},   {n:"P5", s:7,  r:3/2,   f:"3/2"},
    {n:"m6", s:8, r:8/5,    f:"8/5"},   {n:"M6", s:9,  r:5/3,   f:"5/3"},
    {n:"m7", s:10,r:16/9,   f:"16/9"},  {n:"M7", s:11, r:15/8,  f:"15/8"},
    {n:"Oct",s:12,r:2,      f:"2/1"}
];

// ‚îÄ‚îÄ‚îÄ DRONE STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const prefs = loadPrefs();
let droneState = {
    root:     prefs.droneRoot     ?? 9,
    intervals:new Set(prefs.droneIntervals ?? [0]),
    tuning:   prefs.droneTuning   ?? 'just',
    color:    prefs.droneColor    ?? 'sine',
    running:  false,
    octave:   prefs.droneOctave   ?? 4,
    volume:   prefs.droneVolume   ?? 0.7
};
let activeOscs = [], droneMaster = null;

function getDroneMaster() {
    const ctx = getCtx();
    if (!droneMaster || droneMaster.context !== ctx) {
        droneMaster = ctx.createGain();
        droneMaster.gain.value = droneState.volume;
        droneMaster.connect(ctx.destination);
    }
    return droneMaster;
}

function getIntervalLabel() {
    return [...droneState.intervals].sort((a,b)=>a-b)
        .map(s => droneRatios.find(r=>r.s===s).n).join('+');
}

function updateDroneDebug() {
    const refA = parseFloat(document.getElementById('droneRef').value) || 440;
    const rootFreq = (refA * Math.pow(2,(droneState.root-9)/12)) * Math.pow(2,droneState.octave-4);
    let txt = `ROOT: ${noteNames[droneState.root]} @ ${rootFreq.toFixed(2)}Hz\nMODE: ${droneState.tuning.toUpperCase()}\n\n`;
    [...droneState.intervals].sort((a,b)=>a-b).forEach(s => {
        const iv = droneRatios.find(r=>r.s===s);
        const freq = droneState.tuning==='equal' ? rootFreq*Math.pow(2,s/12) : rootFreq*iv.r;
        const ratio = droneState.tuning==='equal' ? `2^(${s}/12)` : `${iv.f} (${iv.r.toFixed(3)})`;
        txt += `${iv.n.padEnd(4)}: ${freq.toFixed(2)}Hz | ${ratio}\n`;
    });
    document.getElementById('debug-console').innerText = txt;
    savePrefs();
}

function startDrone() {
    const ctx = getCtx();
    const refA = parseFloat(document.getElementById('droneRef').value) || 440;
    const rootFreq = (refA * Math.pow(2,(droneState.root-9)/12)) * Math.pow(2,droneState.octave-4);
    const master = getDroneMaster();
    droneState.intervals.forEach(s => {
        const iv = droneRatios.find(r=>r.s===s);
        const f = droneState.tuning==='equal' ? rootFreq*Math.pow(2,s/12) : rootFreq*iv.r;
        const osc = ctx.createOscillator(), g = ctx.createGain();
        osc.type = droneState.color;
        osc.frequency.setValueAtTime(f, ctx.currentTime);
        g.gain.setValueAtTime(0, ctx.currentTime);
        g.gain.linearRampToValueAtTime(0.15, ctx.currentTime+0.12);
        osc.connect(g).connect(master);
        osc.start();
        activeOscs.push({osc, g});
    });
}

const stopDrone = () => {
    const ctx = getCtx();
    activeOscs.forEach(n => {
        n.g.gain.linearRampToValueAtTime(0, ctx.currentTime+0.1);
        setTimeout(() => { try { n.osc.stop(); } catch(e){} }, 150);
    });
    activeOscs = [];
};

const droneSync = () => { updateDroneDebug(); if(droneState.running){ stopDrone(); startDrone(); } };

// Build root grid
noteNames.forEach((n,i) => {
    const b = document.createElement('button');
    b.className='btn-toggle'; b.textContent=n;
    if(i===droneState.root) b.classList.add('active');
    b.onclick = () => {
        document.querySelectorAll('#rootGrid .btn-toggle').forEach(x=>x.classList.remove('active'));
        b.classList.add('active'); droneState.root=i; droneSync();
    };
    document.getElementById('rootGrid').appendChild(b);
});

// Build interval grid
droneRatios.forEach(rt => {
    const b = document.createElement('button');
    b.className='btn-toggle'; b.textContent=rt.n;
    if(droneState.intervals.has(rt.s)) b.classList.add('active');
    b.onclick = () => {
        if(droneState.intervals.has(rt.s) && droneState.intervals.size>1) {
            droneState.intervals.delete(rt.s); b.classList.remove('active');
        } else {
            droneState.intervals.add(rt.s); b.classList.add('active');
        }
        droneSync();
    };
    document.getElementById('intervalGrid').appendChild(b);
});

document.getElementById('droneToggle').onclick = function() {
    droneState.running = !droneState.running;
    if(droneState.running){ startDrone(); this.textContent='üéµ Stop Drone'; this.classList.add('is-active'); }
    else { stopDrone(); this.textContent='üéµ Start Drone'; this.classList.remove('is-active'); }
};

document.getElementById('droneClear').onclick = () => {
    droneState.intervals = new Set([0]);
    document.querySelectorAll('#intervalGrid .btn-toggle').forEach((b,i)=>b.classList.toggle('active',i===0));
    droneSync();
};

// Restore saved values
const droneRefInput = document.getElementById('droneRef');
const droneRefVal   = document.getElementById('droneRefVal');
const droneOctaveInput = document.getElementById('droneOctave');
const droneOctaveVal   = document.getElementById('droneOctaveVal');

if(prefs.droneRef) { droneRefInput.value = prefs.droneRef; droneRefVal.textContent = prefs.droneRef; }
droneOctaveInput.value = droneState.octave;
droneOctaveVal.textContent = droneState.octave;

document.getElementById('droneRefMinus').onclick = () => {
    const v = Math.max(400, (parseFloat(droneRefInput.value)||440) - 1);
    droneRefInput.value = v; droneRefVal.textContent = v; droneSync();
};
document.getElementById('droneRefPlus').onclick = () => {
    const v = Math.min(480, (parseFloat(droneRefInput.value)||440) + 1);
    droneRefInput.value = v; droneRefVal.textContent = v; droneSync();
};
document.getElementById('droneOctaveMinus').onclick = () => {
    const v = Math.max(1, (parseInt(droneOctaveInput.value)||4) - 1);
    droneOctaveInput.value = v; droneOctaveVal.textContent = v; droneState.octave=v; droneSync();
};
document.getElementById('droneOctavePlus').onclick = () => {
    const v = Math.min(6, (parseInt(droneOctaveInput.value)||4) + 1);
    droneOctaveInput.value = v; droneOctaveVal.textContent = v; droneState.octave=v; droneSync();
};

// Volume slider
document.getElementById('droneVolume').value = droneState.volume;
document.getElementById('droneVolume').oninput = e => {
    droneState.volume = parseFloat(e.target.value);
    if(droneMaster) droneMaster.gain.value = droneState.volume;
    savePrefs();
};

// Tuning + wave switches ‚Äî restore saved state
['tuningSwitch','colorSwitch'].forEach(id => {
    const key = id==='tuningSwitch' ? 'tuning' : 'color';
    document.querySelectorAll(`#${id} button`).forEach(b => b.classList.toggle('active', b.dataset.val===droneState[key]));
    document.getElementById(id).onclick = e => {
        if(e.target.tagName!=='BUTTON') return;
        document.querySelectorAll(`#${id} button`).forEach(b=>b.classList.remove('active'));
        e.target.classList.add('active');
        droneState[key]=e.target.dataset.val; droneSync();
    };
});

// Details toggle
const detailsBtn = document.getElementById('detailsToggle');
const debugEl    = document.getElementById('debug-console');
detailsBtn.onclick = () => {
    const open = debugEl.style.display !== 'none';
    debugEl.style.display = open ? 'none' : 'block';
    detailsBtn.textContent = open ? 'üî¨ Show Details' : 'üî¨ Hide Details';
};

// ‚îÄ‚îÄ‚îÄ METRONOME STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let bpm         = prefs.bpm         ?? 120;
let timeSig     = prefs.timeSig     ?? 4;
let subdivision = prefs.subdivision ?? 1;
let metroSound  = prefs.metroSound  ?? false;
let metroLight  = prefs.metroLight  ?? false;
let metroVolume = prefs.metroVolume ?? 0.7;
let clickSound  = prefs.clickSound  ?? 'clave';
let metroRunning=false, nextBeat=0, schedTimer, beatCount=0;
let metroMaster = null;

function getMetroMaster() {
    const ctx = getCtx();
    if (!metroMaster || metroMaster.context !== ctx) {
        metroMaster = ctx.createGain();
        metroMaster.gain.value = metroVolume;
        metroMaster.connect(ctx.destination);
    }
    return metroMaster;
}

const bpmDisplay = document.getElementById('bpm-display');
const bpmInput   = document.getElementById('bpm-input');
const metroCard  = document.getElementById('metro-card');
const wheelEl    = document.getElementById('wheel');

const updateBPMDisplay = v => {
    bpm = Math.min(Math.max(v,40),280);
    bpmDisplay.textContent = bpm;
    bpmInput.value = bpm;
    wheelEl.style.transform = `rotate(${bpm*1.5}deg)`;
};
const updateBPM = v => { updateBPMDisplay(v); savePrefs(); };

bpmDisplay.onclick = () => { bpmDisplay.style.display='none'; bpmInput.style.display='block'; bpmInput.focus(); };
bpmInput.onblur   = () => { updateBPM(parseInt(bpmInput.value)||120); bpmInput.style.display='none'; bpmDisplay.style.display='block'; };
bpmInput.onkeydown = e => { if(e.key==='Enter') bpmInput.blur(); };
document.getElementById('bpmMinus').onclick = () => updateBPM(bpm-1);
document.getElementById('bpmPlus').onclick  = () => updateBPM(bpm+1);

// Metro volume slider
document.getElementById('metroVolume').value = metroVolume;
document.getElementById('metroVolume').oninput = e => {
    metroVolume = parseFloat(e.target.value);
    if(metroMaster) metroMaster.gain.value = metroVolume;
    savePrefs();
};

// Restore seg controls
document.querySelectorAll('#timeSigCtrl button').forEach(b=>b.classList.toggle('active',parseInt(b.dataset.val)===timeSig));
document.querySelectorAll('#subdivCtrl  button').forEach(b=>b.classList.toggle('active',parseInt(b.dataset.val)===subdivision));
document.querySelectorAll('#clickSoundCtrl button').forEach(b=>b.classList.toggle('active',b.dataset.val===clickSound));

document.getElementById('timeSigCtrl').onclick = e => {
    if(e.target.tagName!=='BUTTON') return;
    document.querySelectorAll('#timeSigCtrl button').forEach(b=>b.classList.remove('active'));
    e.target.classList.add('active');
    timeSig=parseInt(e.target.dataset.val); beatCount=0; savePrefs();
};
document.getElementById('subdivCtrl').onclick = e => {
    if(e.target.tagName!=='BUTTON') return;
    document.querySelectorAll('#subdivCtrl button').forEach(b=>b.classList.remove('active'));
    e.target.classList.add('active');
    subdivision=parseInt(e.target.dataset.val); savePrefs();
};
document.getElementById('clickSoundCtrl').onclick = e => {
    if(e.target.tagName!=='BUTTON') return;
    document.querySelectorAll('#clickSoundCtrl button').forEach(b=>b.classList.remove('active'));
    e.target.classList.add('active');
    clickSound=e.target.dataset.val; savePrefs();
};

// ‚îÄ‚îÄ‚îÄ CLICK SOUNDS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function playClave(atTime, isAccent) {
    const ctx = getCtx(), SR = ctx.sampleRate, out = getMetroMaster();
    const vol = isAccent ? 1.0 : 0.60, freq = isAccent ? 2750 : 2450;
    const body = ctx.createOscillator(), bG = ctx.createGain();
    body.type='sine';
    body.frequency.setValueAtTime(freq, atTime);
    body.frequency.exponentialRampToValueAtTime(freq*0.87, atTime+0.045);
    bG.gain.setValueAtTime(vol*0.6, atTime);
    bG.gain.exponentialRampToValueAtTime(0.001, atTime+0.045);
    body.connect(bG).connect(out); body.start(atTime); body.stop(atTime+0.055);

    const cLen=Math.floor(SR*0.013), nbuf=ctx.createBuffer(1,cLen,SR);
    const nd=nbuf.getChannelData(0); for(let i=0;i<cLen;i++) nd[i]=Math.random()*2-1;
    const noise=ctx.createBufferSource(); noise.buffer=nbuf;
    const bp=ctx.createBiquadFilter(); bp.type='bandpass'; bp.frequency.value=3100; bp.Q.value=1.3;
    const cG=ctx.createGain();
    cG.gain.setValueAtTime(vol*0.48, atTime); cG.gain.exponentialRampToValueAtTime(0.001, atTime+0.013);
    noise.connect(bp).connect(cG).connect(out); noise.start(atTime); noise.stop(atTime+0.016);

    const res=ctx.createOscillator(), rG=ctx.createGain();
    res.type='sine'; res.frequency.setValueAtTime(3700, atTime);
    rG.gain.setValueAtTime(vol*0.18, atTime); rG.gain.exponentialRampToValueAtTime(0.001, atTime+0.022);
    res.connect(rG).connect(out); res.start(atTime); res.stop(atTime+0.028);
}

function playClick(atTime, isAccent) {
    // Mechanical metronome click: sharp sine with very fast decay
    const ctx = getCtx(), out = getMetroMaster();
    const vol = isAccent ? 1.0 : 0.65, freq = isAccent ? 1200 : 900;
    const o = ctx.createOscillator(), g = ctx.createGain();
    o.type = 'square';
    o.frequency.setValueAtTime(freq, atTime);
    o.frequency.exponentialRampToValueAtTime(freq*0.5, atTime+0.018);
    g.gain.setValueAtTime(vol*0.4, atTime);
    g.gain.exponentialRampToValueAtTime(0.001, atTime+0.018);
    const lp = ctx.createBiquadFilter(); lp.type='lowpass'; lp.frequency.value=2200;
    o.connect(lp).connect(g).connect(out); o.start(atTime); o.stop(atTime+0.022);
}

function playRim(atTime, isAccent) {
    // Snare rim shot: noise filtered to midrange with sharp transient
    const ctx = getCtx(), SR = ctx.sampleRate, out = getMetroMaster();
    const vol = isAccent ? 1.0 : 0.6;
    const dur = isAccent ? 0.055 : 0.04;
    const len = Math.floor(SR * dur);
    const buf = ctx.createBuffer(1, len, SR);
    const d = buf.getChannelData(0);
    for(let i=0;i<len;i++) d[i] = (Math.random()*2-1) * Math.exp(-i/(len*0.3));
    const src = ctx.createBufferSource(); src.buffer = buf;
    const hp = ctx.createBiquadFilter(); hp.type='highpass'; hp.frequency.value = isAccent ? 900 : 700; hp.Q.value=2;
    const bp = ctx.createBiquadFilter(); bp.type='peaking'; bp.frequency.value=2500; bp.gain.value=8;
    const g = ctx.createGain(); g.gain.setValueAtTime(vol*0.9, atTime);
    src.connect(hp).connect(bp).connect(g).connect(out);
    src.start(atTime); src.stop(atTime+dur+0.01);
    // Add a ping for the accent
    if(isAccent) {
        const ping=ctx.createOscillator(), pg=ctx.createGain();
        ping.type='sine'; ping.frequency.setValueAtTime(1600, atTime);
        pg.gain.setValueAtTime(0.3, atTime); pg.gain.exponentialRampToValueAtTime(0.001, atTime+0.03);
        ping.connect(pg).connect(out); ping.start(atTime); ping.stop(atTime+0.035);
    }
}

function playCowbell(atTime, isAccent) {
    // Classic cowbell: two detuned square waves + metal resonance
    const ctx = getCtx(), out = getMetroMaster();
    const vol = isAccent ? 1.0 : 0.62;
    const dur = isAccent ? 0.28 : 0.18;
    [[562, 1], [845, 0.6]].forEach(([f, fvol]) => {
        const o=ctx.createOscillator(), g=ctx.createGain();
        o.type='square'; o.frequency.value=f;
        const bp=ctx.createBiquadFilter(); bp.type='bandpass'; bp.frequency.value=f*1.4; bp.Q.value=0.8;
        g.gain.setValueAtTime(vol*fvol*0.3, atTime);
        g.gain.exponentialRampToValueAtTime(0.001, atTime+dur);
        o.connect(bp).connect(g).connect(out); o.start(atTime); o.stop(atTime+dur+0.01);
    });
    // Metal click transient
    const o2=ctx.createOscillator(), g2=ctx.createGain();
    o2.type='triangle'; o2.frequency.setValueAtTime(3500, atTime); o2.frequency.exponentialRampToValueAtTime(1800, atTime+0.015);
    g2.gain.setValueAtTime(vol*0.5, atTime); g2.gain.exponentialRampToValueAtTime(0.001, atTime+0.015);
    o2.connect(g2).connect(out); o2.start(atTime); o2.stop(atTime+0.02);
}

function playBeat(atTime, isAccent) {
    if(clickSound==='clave')   playClave(atTime, isAccent);
    else if(clickSound==='click') playClick(atTime, isAccent);
    else if(clickSound==='rim')   playRim(atTime, isAccent);
    else if(clickSound==='cowbell') playCowbell(atTime, isAccent);
}

function playSubdiv(atTime) {
    const ctx = getCtx(), out = getMetroMaster();
    const o=ctx.createOscillator(), g=ctx.createGain();
    o.type='sine'; o.frequency.value=1900;
    g.gain.setValueAtTime(0.11, atTime);
    g.gain.exponentialRampToValueAtTime(0.001, atTime+0.02);
    o.connect(g).connect(out);
    o.start(atTime); o.stop(atTime+0.025);
}

function triggerFlash(atTime, isAccent) {
    const delay = Math.max(0, (atTime-getCtx().currentTime)*1000);
    setTimeout(() => {
        wheelEl.classList.add('beat-flash');
        metroCard.classList.add('beat-flash');
        setTimeout(() => {
            wheelEl.classList.remove('beat-flash');
            metroCard.classList.remove('beat-flash');
        }, isAccent ? 130 : 80);
    }, delay);
}

function sched() {
    const ctx = getCtx();
    while(nextBeat < ctx.currentTime+0.1) {
        const isAccent = (beatCount % timeSig === 0);
        if(metroSound) playBeat(nextBeat, isAccent);
        if(metroLight) triggerFlash(nextBeat, isAccent);
        if(subdivision > 1) {
            const step = (60/bpm)/subdivision;
            for(let s=1; s<subdivision; s++) {
                const st = nextBeat + s*step;
                if(metroSound) playSubdiv(st);
            }
        }
        beatCount++;
        nextBeat += 60/bpm;
    }
    schedTimer = setTimeout(sched, 25);
}

function updateMetroBtn() {
    const btn=document.getElementById('metroStartBtn');
    if(!btn) return;
    if(metroRunning){ btn.innerHTML='‚ñ†<br>Stop'; btn.classList.add('is-active'); }
    else { btn.innerHTML='‚ñ∂<br>Start'; btn.classList.remove('is-active'); }
}
function startMetro() {
    if(metroRunning) return;
    metroRunning=true; beatCount=0;
    nextBeat=getCtx().currentTime; sched();
    updateMetroBtn();
}
function stopMetro() {
    if(!metroRunning) return;
    metroRunning=false; clearTimeout(schedTimer);
    wheelEl.classList.remove('beat-flash');
    metroCard.classList.remove('beat-flash');
    updateMetroBtn();
}
// Restore output toggle states
if(metroSound) document.getElementById('soundToggle').classList.add('active');
if(metroLight) document.getElementById('lightToggle').classList.add('active');

document.getElementById('soundToggle').onclick = function() { metroSound=!metroSound; this.classList.toggle('active',metroSound); savePrefs(); };
document.getElementById('lightToggle').onclick = function() { metroLight=!metroLight; this.classList.toggle('active',metroLight); savePrefs(); };
document.getElementById('metroStartBtn').onclick = function() {
    if(metroRunning) { stopMetro(); }
    else { startMetro(); }
    savePrefs();
};

// Tap tempo
let tapTimes=[], tapResetTimer=null;
document.getElementById('tapBtn').onclick = () => {
    const now=performance.now();
    clearTimeout(tapResetTimer);
    if(tapTimes.length && now-tapTimes[tapTimes.length-1]>2000) tapTimes=[];
    tapTimes.push(now);
    if(tapTimes.length>=2) {
        const gaps=tapTimes.slice(1).map((t,i)=>t-tapTimes[i]);
        updateBPM(Math.round(60000/(gaps.reduce((a,b)=>a+b)/gaps.length)));
        if(metroRunning){ clearTimeout(schedTimer); beatCount=0; nextBeat=getCtx().currentTime; sched(); }
    }
    if(tapTimes.length>8) tapTimes=tapTimes.slice(-8);
    tapResetTimer=setTimeout(()=>{ tapTimes=[]; },2000);
};

// Wheel drag
(function(){
    const outer=wheelEl.parentElement;
    let dragging=false, lastAngle=0, fracBpm=0;
    const getAngle=e=>{
        const r=outer.getBoundingClientRect();
        const px=e.touches?e.touches[0].clientX:e.clientX;
        const py=e.touches?e.touches[0].clientY:e.clientY;
        return Math.atan2(py-(r.top+r.height/2), px-(r.left+r.width/2))*(180/Math.PI);
    };
    const onMove=e=>{
        if(!dragging)return;
        const angle=getAngle(e);
        let d=angle-lastAngle; lastAngle=angle;
        if(d>180)d-=360; if(d<-180)d+=360;
        fracBpm+=d/3;
        const whole=Math.trunc(fracBpm);
        if(whole!==0){ updateBPMDisplay(bpm+whole); fracBpm-=whole; }
    };
    const onEnd=()=>{
        if(!dragging)return;
        dragging=false; wheelEl.style.cursor='grab';
        fracBpm=0;
        savePrefs();
    };
    wheelEl.addEventListener('mousedown',e=>{ e.preventDefault(); dragging=true; lastAngle=getAngle(e); fracBpm=0; wheelEl.style.cursor='grabbing'; });
    window.addEventListener('mousemove',onMove);
    window.addEventListener('mouseup',onEnd);
    wheelEl.addEventListener('touchstart',e=>{ e.preventDefault(); dragging=true; lastAngle=getAngle(e); fracBpm=0; },{passive:false});
    window.addEventListener('touchmove',e=>{ if(!dragging)return; e.preventDefault(); onMove(e); },{passive:false});
    window.addEventListener('touchend',onEnd);
})();

// ‚îÄ‚îÄ‚îÄ RECORDER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let recorder, chunks=[], liveAnimFrame=null, liveAnalyser=null, memoUrls=[];

// ‚îÄ‚îÄ Pick the best supported MIME type for this browser ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// iOS Safari only supports audio/mp4; Chrome/Firefox prefer audio/webm
function getSupportedMimeType() {
    const types = ['audio/webm;codecs=opus', 'audio/webm', 'audio/mp4', 'audio/ogg;codecs=opus', ''];
    return types.find(t => !t || MediaRecorder.isTypeSupported(t)) || '';
}

function mimeToExt(mime) {
    if(mime.includes('mp4')) return 'mp4';
    if(mime.includes('ogg')) return 'ogg';
    return 'webm';
}

function drawLiveWaveform() {
    const canvas=document.getElementById('liveWaveform');
    const c2d=canvas.getContext('2d');
    canvas.width=canvas.offsetWidth;
    const buf=new Uint8Array(liveAnalyser.fftSize);
    (function draw(){
        if(!liveAnalyser) return;
        liveAnimFrame=requestAnimationFrame(draw);
        liveAnalyser.getByteTimeDomainData(buf);
        c2d.clearRect(0,0,canvas.width,canvas.height);
        c2d.strokeStyle='#22c55e'; c2d.lineWidth=2;
        c2d.beginPath();
        const sw=canvas.width/buf.length; let x=0;
        for(let i=0;i<buf.length;i++){
            const y=(buf[i]/128)*canvas.height/2;
            i===0?c2d.moveTo(x,y):c2d.lineTo(x,y); x+=sw;
        }
        c2d.lineTo(canvas.width,canvas.height/2); c2d.stroke();
    })();
}

function stopLiveWaveform() {
    if(liveAnimFrame){ cancelAnimationFrame(liveAnimFrame); liveAnimFrame=null; }
    liveAnalyser=null;
    const canvas=document.getElementById('liveWaveform');
    canvas.style.display='none';
    canvas.getContext('2d').clearRect(0,0,canvas.width,canvas.height);
}

function getAutoName() {
    const now=new Date();
    const d=now.toLocaleDateString([],{month:'short',day:'numeric'});
    const t=now.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
    return `${d} ${t}`;
}

document.getElementById('recordToggle').onclick = async function() {
    if(recorder?.state==='recording') {
        recorder.stop(); stopLiveWaveform();
        this.textContent='üéôÔ∏è Start Recording'; this.classList.remove('is-active');
        document.getElementById('rec-status').textContent='';
        return;
    }
    const stream=await navigator.mediaDevices.getUserMedia({audio:true});
    const autoName=getAutoName();
    const mimeType=getSupportedMimeType();
    const recOpts=mimeType ? {mimeType} : {};
    recorder=new MediaRecorder(stream, recOpts); chunks=[];
    recorder.ondataavailable=e=>{ if(e.data.size>0) chunks.push(e.data); };
    recorder.onstop=()=>{
        stream.getTracks().forEach(t=>t.stop());
        const actualMime=recorder.mimeType||mimeType||'audio/webm';
        const blob=new Blob(chunks,{type:actualMime});
        const item={id:Date.now().toString(), blob, mimeType:actualMime, ts:Date.now(), name:autoName};
        const tx=db.transaction('memos','readwrite');
        tx.objectStore('memos').put(item);
        tx.oncomplete=renderMemos;
    };
    // iOS: resume AudioContext before creating source (requires user gesture ‚Äî we're inside one)
    const ctx=getCtx();
    liveAnalyser=ctx.createAnalyser(); liveAnalyser.fftSize=2048;
    ctx.createMediaStreamSource(stream).connect(liveAnalyser);
    const canvas=document.getElementById('liveWaveform');
    canvas.style.display='block'; drawLiveWaveform();
    // timeslice=250ms ensures data flows on iOS (which may not fire ondataavailable without it)
    recorder.start(250);
    this.textContent='‚èπÔ∏è Stop Recording'; this.classList.add('is-active');
    document.getElementById('rec-status').textContent='‚óè Recording...';
};

function saveMemoName(m, name) {
    m.name=name.trim()||m.name;
    const tx=db.transaction('memos','readwrite');
    tx.objectStore('memos').put(m);
}

function renderMemos() {
    memoUrls.forEach(u => URL.revokeObjectURL(u)); memoUrls=[];
    const list=document.getElementById('memoList'); list.innerHTML='';
    db.transaction('memos').objectStore('memos').getAll().onsuccess=e=>{
        e.target.result.sort((a,b)=>b.ts-a.ts).forEach(m=>{
            const mime=m.mimeType||(m.blob&&m.blob.type)||'audio/webm';
            const ext=mimeToExt(mime);
            // Create a correctly-typed blob URL ‚Äî critical for iOS to decode it
            const typedBlob=new Blob([m.blob],{type:mime});
            const url=URL.createObjectURL(typedBlob); memoUrls.push(url);
            const label=m.name||`Memo ‚Äî ${new Date(m.ts).toLocaleString()}`;
            const d=document.createElement('div'); d.className='recording-item';
            d.innerHTML=`
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">
                    <strong id="lbl-${m.id}" style="flex:1;cursor:text;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="Click to rename">${label}</strong>
                    <input id="inp-${m.id}" type="text"
                        style="display:none;flex:1;background:var(--bg);border:1px solid var(--primary);color:var(--text);border-radius:6px;padding:4px 8px;font-size:0.95rem;font-weight:700;outline:none;min-width:0;">
                    <button class="secondary" id="ren-${m.id}" style="padding:0.6rem 0.8rem;font-size:0.85rem;flex-shrink:0;min-width:44px;min-height:44px;">‚úèÔ∏è</button>
                </div>
                <div id="w-${m.id}" class="wf-box"></div>
                <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;">
                    <button class="main-action" id="p-${m.id}">‚ñ∂ Play</button>
                    <button class="secondary" id="dl-${m.id}">‚¨á Export</button>
                    <button class="secondary" onclick="deleteMemo('${m.id}')">üóë Delete</button>
                </div>`;
            list.appendChild(d);

            // Use MediaElement backend: lets the browser's native <audio> handle decoding,
            // which is the only reliable approach on iOS Safari for blob URLs.
            const ws=WaveSurfer.create({
                container:`#w-${m.id}`,
                waveColor:'#475569',
                progressColor:'#22c55e',
                backend:'MediaElement',
                url
            });
            const pb=document.getElementById(`p-${m.id}`);
            ws.on('play',()=>pb.textContent='‚è∏ Pause');
            ws.on('pause',()=>pb.textContent='‚ñ∂ Play');
            ws.on('finish',()=>pb.textContent='‚ñ∂ Play');
            // iOS: playPause must be triggered directly from user tap (already is via onclick)
            pb.onclick=()=>ws.playPause();

            document.getElementById(`dl-${m.id}`).onclick=()=>{
                const a=document.createElement('a'); a.href=url;
                a.download=`${(m.name||'memo').replace(/[^\w\s\-]/g,'_').trim()}.${ext}`;
                a.click();
            };

            const lbl=document.getElementById(`lbl-${m.id}`);
            const inp=document.getElementById(`inp-${m.id}`);
            const ren=document.getElementById(`ren-${m.id}`);
            let renaming=false;

            function enterRename() {
                renaming=true; inp.value=lbl.textContent;
                lbl.style.display='none'; inp.style.display='block';
                ren.textContent='‚úì'; inp.focus(); inp.select();
            }
            function commitRename() {
                if(!renaming) return; renaming=false;
                const n=inp.value.trim()||lbl.textContent;
                lbl.textContent=n; lbl.style.display='';
                inp.style.display='none'; ren.textContent='‚úèÔ∏è';
                saveMemoName(m,n);
            }
            ren.onclick=()=>renaming?commitRename():enterRename();
            lbl.onclick=enterRename;
            inp.onblur=()=>setTimeout(commitRename,80);
            inp.onkeydown=e=>{ if(e.key==='Enter')commitRename(); if(e.key==='Escape'){renaming=false;inp.style.display='none';lbl.style.display='';ren.textContent='‚úèÔ∏è';} };
        });
    };
}

window.deleteMemo = id => {
    if(!confirm('Delete this memo?')) return;
    const tx=db.transaction('memos','readwrite');
    tx.objectStore('memos').delete(id);
    tx.oncomplete=renderMemos;
};

// ‚îÄ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
initDB().then(()=>{
    updateBPM(bpm);
    droneSync();
    renderMemos();
});
</script>
</body>
</html>
