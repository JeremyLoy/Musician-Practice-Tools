<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Musician's Practice Toolkit</title>
    <script src="https://unpkg.com/wavesurfer.js@7"></script>
    <style>
        :root {
            --primary: #22c55e;
            --primary-hover: #16a34a;
            --danger: #ef4444;
            --danger-hover: #dc2626;
            --bg: #0f172a;
            --surface: #1e293b;
            --border: #334155;
            --text: #f1f5f9;
            --text-muted: #94a3b8;
        }

        body { font-family: system-ui, -apple-system, sans-serif; background-color: var(--bg); color: var(--text); max-width: 850px; margin: 0 auto; padding: 2rem; line-height: 1.5; }
        h1 { text-align: center; margin-bottom: 2rem; font-weight: 800; }
        h2 { margin-top: 0; color: var(--text-muted); font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 1.5rem; }

        .card { background: var(--surface); border: 1px solid var(--border); border-radius: 16px; padding: 2rem; margin-bottom: 2rem; box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.4); }
        .drone-section { display: flex; flex-direction: column; gap: 1.5rem; }
        .selector-label { font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 0.5rem; font-weight: bold; }
        
        .root-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px; }
        .interval-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(65px, 1fr)); gap: 8px; }

        .btn-toggle { background: var(--bg); border: 1px solid var(--border); color: var(--text); padding: 10px 5px; border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-weight: 600; transition: all 0.2s; }
        .btn-toggle.active { background: var(--primary); border-color: var(--primary); color: white; }

        .settings-bar { display: flex; flex-wrap: wrap; gap: 15px; padding: 1.2rem; background: rgba(0,0,0,0.3); border-radius: 12px; align-items: center; justify-content: center; border: 1px solid var(--border); }
        .control-group { display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .switch-ui { display: flex; background: var(--bg); border-radius: 8px; padding: 4px; border: 1px solid var(--border); }
        .switch-ui button { background: transparent; color: var(--text-muted); border: none; padding: 4px 10px; font-size: 0.7rem; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .switch-ui button.active { background: var(--primary); color: white; }

        #debug-console { background: #000; color: #22c55e; font-family: 'Courier New', monospace; font-size: 0.75rem; padding: 12px; border-radius: 8px; margin-top: 1rem; min-height: 80px; border: 1px solid #166534; white-space: pre-wrap; }

        #flash-bar { width: 100%; height: 12px; background: var(--border); border-radius: 6px; margin-bottom: 2rem; transition: background 0.05s ease-out; }
        #flash-bar.active { background: var(--primary); box-shadow: 0 0 20px var(--primary); }

        .wheel-outer { position: relative; width: 220px; height: 220px; margin: 0 auto; user-select: none; touch-action: none; }
        #wheel { width: 100%; height: 100%; border-radius: 50%; background: radial-gradient(circle, #1e293b 30%, #0f172a 100%); border: 12px solid var(--border); position: relative; cursor: grab; }
        #wheel::after { content: ''; position: absolute; top: 15px; left: 50%; transform: translateX(-50%); width: 14px; height: 14px; background: var(--primary); border-radius: 50%; }

        .bpm-container { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; width: 140px; pointer-events: none; z-index: 2; }
        #bpm-display { font-size: 3.5rem; font-weight: 900; color: var(--text); cursor: pointer; line-height: 1; pointer-events: auto; }
        #bpm-input { width: 100%; background: transparent; border: none; color: var(--primary); font-size: 3.5rem; font-weight: 900; text-align: center; display: none; outline: none; pointer-events: auto; }

        .recording-item { background: var(--surface); border: 1px solid var(--border); padding: 1.5rem; margin-bottom: 1.5rem; border-radius: 16px; }
        .wf-box { height: 100px; background: rgba(0,0,0,0.5); border-radius: 8px; margin: 15px 0; overflow: hidden; }

        button.main-action { background: var(--primary); color: white; border: none; padding: 0.8rem 1.8rem; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 1rem; }
        button.main-action.is-active { background: var(--danger); }
        button.secondary { background: var(--border); color: var(--text); padding: 0.8rem 1.8rem; border-radius: 10px; font-weight: bold; cursor: pointer; border: none; }
        .num-input { background: var(--bg); border: 1px solid var(--border); color: var(--primary); padding: 5px; border-radius: 4px; width: 50px; text-align: center; font-weight: bold; }
        .metro-mode-btn.is-active { background: var(--primary); color: white; border-color: var(--primary); }
    </style>
</head>
<body>

    <h1>Musician's Practice Toolkit</h1>

    <div class="card">
        <h2>Drone Machine</h2>
        <div class="drone-section">
            <div>
                <span class="selector-label">1. Root Note</span>
                <div class="root-grid" id="rootGrid"></div>
            </div>
            <div>
                <span class="selector-label">2. Chord Intervals</span>
                <div class="interval-grid" id="intervalGrid"></div>
            </div>
            <div class="settings-bar">
                <div class="control-group"><span class="selector-label">A Ref</span><input type="number" id="droneRef" value="440" class="num-input"></div>
                <div class="control-group"><span class="selector-label">Octave</span><input type="number" id="droneOctave" value="4" min="1" max="6" class="num-input"></div>
                <div class="control-group"><span class="selector-label">Tuning</span><div class="switch-ui" id="tuningSwitch"><button data-val="just" class="active">JUST</button><button data-val="equal">ET</button></div></div>
                <div class="control-group"><span class="selector-label">Waveform</span><div class="switch-ui" id="colorSwitch"><button data-val="sine" class="active">SINE</button><button data-val="triangle">TRI</button></div></div>
                <div style="display: flex; gap: 10px;"><button id="droneToggle" class="main-action">Start Drone</button><button id="droneClear" class="secondary">Clear</button></div>
            </div>
            <div id="debug-console">Debug: Select notes...</div>
        </div>
    </div>

    <div class="card">
        <h2>Metronome</h2>
        <div id="flash-bar"></div>
        <div class="wheel-outer">
            <div class="bpm-container">
                <div id="bpm-display">120</div>
                <input type="number" id="bpm-input" min="40" max="280">
            </div>
            <div id="wheel"></div>
        </div>
        <div style="margin-top: 2rem; display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap; align-items: center;">
            <button id="soundToggle" class="secondary metro-mode-btn">ü•Å Sound</button>
            <button id="lightToggle" class="secondary metro-mode-btn">üí° Light</button>
            <button id="tapBtn" class="secondary">Tap Tempo</button>
        </div>
    </div>

    <div class="card">
        <h2>Audio Memos</h2>
        <div style="text-align:center;"><button id="recordToggle" class="main-action">Start Recording</button></div>
        <div id="status" style="margin-top:1rem; height: 20px; color: var(--primary); font-weight: bold; font-size: 0.8rem; text-align: center;"></div>
        <canvas id="liveWaveform" height="80" style="width:100%; display:none; border-radius:8px; background:rgba(0,0,0,0.5); margin-top:1rem;"></canvas>
    </div>

    <div id="memoList"></div>

    <script>
        let audioCtx, db;
        const getCtx = () => { if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); if(audioCtx.state === 'suspended') audioCtx.resume(); return audioCtx; };

        const initDB = () => {
            return new Promise((res) => {
                const req = indexedDB.open('MusiciansToolkit', 1);
                req.onupgradeneeded = (e) => { e.target.result.createObjectStore('memos', { keyPath: 'id' }); };
                req.onsuccess = (e) => { db = e.target.result; res(); };
            });
        };

        // --- DRONE ---
        const noteNames = ["C", "C#", "D", "Eb", "E", "F", "F#", "G", "Ab", "A", "Bb", "B"];
        const droneRatios = [
            {n:"Uni", s:0, r:1/1, f:"1/1"},   {n:"m2", s:1, r:16/15, f:"16/15"}, {n:"M2", s:2, r:9/8, f:"9/8"}, 
            {n:"m3", s:3, r:6/5, f:"6/5"},     {n:"M3", s:4, r:5/4, f:"5/4"},     {n:"P4", s:5, r:4/3, f:"4/3"}, 
            {n:"TT", s:6, r:7/5, f:"7/5"},     {n:"P5", s:7, r:3/2, f:"3/2"},     {n:"m6", s:8, r:8/5, f:"8/5"}, 
            {n:"M6", s:9, r:5/3, f:"5/3"},     {n:"m7", s:10, r:16/9, f:"16/9"},  {n:"M7", s:11, r:15/8, f:"15/8"}, {n:"Oct", s:12, r:2/1, f:"2/1"}
        ];

        // START IN A (index 9), OCTAVE 4
        let droneState = { root: 9, intervals: new Set([0]), tuning: 'just', color: 'sine', running: false, octave: 4 };
        let activeOscs = [];

        function updateDroneDebug() {
            const refA = parseFloat(document.getElementById('droneRef').value) || 440;
            const rootFreq = (refA * Math.pow(2, (droneState.root - 9) / 12)) * Math.pow(2, droneState.octave - 4);
            let txt = `ROOT: ${noteNames[droneState.root]} @ ${rootFreq.toFixed(2)}Hz\nMODE: ${droneState.tuning.toUpperCase()}\n\n`;
            
            // SORT ASCENDING
            Array.from(droneState.intervals).sort((a,b)=>a-b).forEach(s => {
                const interval = droneRatios.find(r=>r.s===s);
                const freq = (droneState.tuning === 'equal') ? rootFreq * Math.pow(2, s/12) : rootFreq * interval.r;
                const ratioText = (droneState.tuning === 'equal') ? `2^(${s}/12)` : `${interval.f} (${interval.r.toFixed(3)})`;
                txt += `${interval.n.padEnd(4)}: ${freq.toFixed(2)}Hz | Ratio: ${ratioText}\n`;
            });
            document.getElementById('debug-console').innerText = txt;
        }

        function startDrone() {
            const ctx = getCtx();
            const refA = parseFloat(document.getElementById('droneRef').value) || 440;
            const rootFreq = (refA * Math.pow(2, (droneState.root - 9) / 12)) * Math.pow(2, droneState.octave - 4);
            droneState.intervals.forEach(s => {
                const interval = droneRatios.find(r=>r.s===s);
                const f = (droneState.tuning === 'equal') ? rootFreq * Math.pow(2, s/12) : rootFreq * interval.r;
                const osc = ctx.createOscillator(); const g = ctx.createGain();
                osc.type = droneState.color; osc.frequency.setValueAtTime(f, ctx.currentTime);
                g.gain.setValueAtTime(0, ctx.currentTime); g.gain.linearRampToValueAtTime(0.1, ctx.currentTime + 0.1);
                osc.connect(g).connect(ctx.destination); osc.start(); activeOscs.push({osc, g});
            });
        }

        const stopDrone = () => { activeOscs.forEach(n => { n.g.gain.linearRampToValueAtTime(0, getCtx().currentTime + 0.1); setTimeout(()=> { try { n.osc.stop(); } catch(e){} }, 150); }); activeOscs = []; };
        const droneSync = () => { updateDroneDebug(); if(droneState.running) { stopDrone(); startDrone(); } };

        noteNames.forEach((n, i) => { 
            const b = document.createElement('button'); b.className = 'btn-toggle'; b.textContent = n; 
            if(i===9) b.classList.add('active'); // DEFAULT A
            b.onclick = () => { document.querySelectorAll('#rootGrid .btn-toggle').forEach(x=>x.classList.remove('active')); b.classList.add('active'); droneState.root = i; droneSync(); }; 
            document.getElementById('rootGrid').appendChild(b); 
        });
        
        droneRatios.forEach(rt => { 
            const b = document.createElement('button'); b.className = 'btn-toggle'; b.textContent = rt.n; if(rt.s===0) b.classList.add('active'); 
            b.onclick = () => { if(droneState.intervals.has(rt.s) && droneState.intervals.size > 1) { droneState.intervals.delete(rt.s); b.classList.remove('active'); } else { droneState.intervals.add(rt.s); b.classList.add('active'); } droneSync(); }; 
            document.getElementById('intervalGrid').appendChild(b); 
        });

        document.getElementById('droneToggle').onclick = function() { droneState.running = !droneState.running; if(droneState.running) { startDrone(); this.textContent="Stop"; this.classList.add('is-active'); } else { stopDrone(); this.textContent="Start"; this.classList.remove('is-active'); } };
        
        document.getElementById('droneOctave').onchange = (e) => { droneState.octave = parseInt(e.target.value); droneSync(); };
        document.getElementById('droneRef').onchange = (e) => { droneSync(); };

        ['tuningSwitch', 'colorSwitch'].forEach(id => document.getElementById(id).onclick = (e) => { if(e.target.tagName==='BUTTON') { document.querySelectorAll(`#${id} button`).forEach(b=>b.classList.remove('active')); e.target.classList.add('active'); droneState[id==='tuningSwitch'?'tuning':'color'] = e.target.dataset.val; droneSync(); } });

        // --- METRONOME ---
        let bpm = 120, metroRunning = false, nextBeat = 0, timer;
        let metroSound = false, metroLight = false;

        const bpmDisplay = document.getElementById('bpm-display'), bpmInput = document.getElementById('bpm-input');
        const updateBPM = (v) => { bpm = Math.min(Math.max(v, 40), 280); bpmDisplay.textContent = bpm; bpmInput.value = bpm; document.getElementById('wheel').style.transform = `rotate(${bpm*1.5}deg)`; };
        bpmDisplay.onclick = () => { bpmDisplay.style.display = 'none'; bpmInput.style.display = 'block'; bpmInput.focus(); };
        bpmInput.onblur = () => { updateBPM(parseInt(bpmInput.value) || 120); bpmInput.style.display = 'none'; bpmDisplay.style.display = 'block'; };
        bpmInput.onkeydown = (e) => { if(e.key === 'Enter') bpmInput.blur(); };

        const flashBar = document.getElementById('flash-bar');

        function playClave(atTime) {
            const ctx = getCtx();
            const SR = ctx.sampleRate;

            // -- Body: sharp sine at clave fundamental with instant attack
            const body = ctx.createOscillator();
            const bodyGain = ctx.createGain();
            body.type = 'sine';
            body.frequency.setValueAtTime(2500, atTime);
            body.frequency.exponentialRampToValueAtTime(2200, atTime + 0.04);
            bodyGain.gain.setValueAtTime(0.65, atTime);
            bodyGain.gain.exponentialRampToValueAtTime(0.001, atTime + 0.04);
            body.connect(bodyGain).connect(ctx.destination);
            body.start(atTime); body.stop(atTime + 0.05);

            // -- Transient click: short noise burst through tight bandpass
            const clickLen = Math.floor(SR * 0.012);
            const noiseBuf = ctx.createBuffer(1, clickLen, SR);
            const nd = noiseBuf.getChannelData(0);
            for(let i = 0; i < clickLen; i++) nd[i] = Math.random() * 2 - 1;
            const noise = ctx.createBufferSource();
            noise.buffer = noiseBuf;
            const bp = ctx.createBiquadFilter();
            bp.type = 'bandpass';
            bp.frequency.value = 3200;
            bp.Q.value = 1.2;
            const clickGain = ctx.createGain();
            clickGain.gain.setValueAtTime(0.5, atTime);
            clickGain.gain.exponentialRampToValueAtTime(0.001, atTime + 0.012);
            noise.connect(bp).connect(clickGain).connect(ctx.destination);
            noise.start(atTime); noise.stop(atTime + 0.015);

            // -- Resonance: subtle high partial for brightness
            const res = ctx.createOscillator();
            const resGain = ctx.createGain();
            res.type = 'sine';
            res.frequency.setValueAtTime(3800, atTime);
            resGain.gain.setValueAtTime(0.2, atTime);
            resGain.gain.exponentialRampToValueAtTime(0.001, atTime + 0.02);
            res.connect(resGain).connect(ctx.destination);
            res.start(atTime); res.stop(atTime + 0.025);
        }

        function triggerFlash(atTime) {
            const msUntil = (atTime - getCtx().currentTime) * 1000;
            setTimeout(() => {
                flashBar.classList.add('active');
                setTimeout(() => flashBar.classList.remove('active'), 80);
            }, Math.max(0, msUntil));
        }

        function sched() {
            while(nextBeat < getCtx().currentTime + 0.1) {
                if(metroSound) playClave(nextBeat);
                if(metroLight) triggerFlash(nextBeat);
                nextBeat += 60/bpm;
            }
            timer = setTimeout(sched, 25);
        }

        function startMetro() {
            if(!metroRunning) {
                metroRunning = true;
                nextBeat = getCtx().currentTime;
                sched();
            }
        }

        function stopMetro() {
            if(metroRunning) {
                metroRunning = false;
                clearTimeout(timer);
                flashBar.classList.remove('active');
            }
        }

        function syncMetroState() {
            if(metroSound || metroLight) startMetro();
            else stopMetro();
        }

        document.getElementById('soundToggle').onclick = function() {
            metroSound = !metroSound;
            this.classList.toggle('is-active', metroSound);
            syncMetroState();
        };

        document.getElementById('lightToggle').onclick = function() {
            metroLight = !metroLight;
            this.classList.toggle('is-active', metroLight);
            syncMetroState();
        };

        // --- TAP TEMPO ---
        let tapTimes = [], tapResetTimer = null;
        document.getElementById('tapBtn').onclick = function() {
            const now = performance.now();
            clearTimeout(tapResetTimer);
            // Reset taps if more than 2 seconds since last tap
            if(tapTimes.length > 0 && now - tapTimes[tapTimes.length - 1] > 2000) tapTimes = [];
            tapTimes.push(now);
            if(tapTimes.length >= 2) {
                const intervals = [];
                for(let i = 1; i < tapTimes.length; i++) intervals.push(tapTimes[i] - tapTimes[i-1]);
                const avgInterval = intervals.reduce((a,b) => a+b, 0) / intervals.length;
                updateBPM(Math.round(60000 / avgInterval));
                if(metroRunning) { clearTimeout(timer); nextBeat = getCtx().currentTime; sched(); }
            }
            if(tapTimes.length > 8) tapTimes = tapTimes.slice(-8);
            tapResetTimer = setTimeout(() => { tapTimes = []; }, 2000);
        };

        // --- WHEEL DRAG ---
        (function() {
            const wheel = document.getElementById('wheel');
            const wheelOuter = wheel.parentElement;
            let dragging = false, lastAngle = 0, lastBpm = 120;

            function getAngle(e) {
                const rect = wheelOuter.getBoundingClientRect();
                const cx = rect.left + rect.width / 2;
                const cy = rect.top + rect.height / 2;
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                return Math.atan2(clientY - cy, clientX - cx) * (180 / Math.PI);
            }

            function onStart(e) {
                e.preventDefault();
                dragging = true;
                lastAngle = getAngle(e);
                lastBpm = bpm;
                wheel.style.cursor = 'grabbing';
            }

            function onMove(e) {
                if (!dragging) return;
                e.preventDefault();
                const angle = getAngle(e);
                let delta = angle - lastAngle;
                // Wrap delta to [-180, 180]
                if (delta > 180) delta -= 360;
                if (delta < -180) delta += 360;
                lastAngle = angle;
                updateBPM(bpm + Math.round(delta / 3));
            }

            function onEnd() {
                dragging = false;
                wheel.style.cursor = 'grab';
            }

            wheel.addEventListener('mousedown', onStart);
            window.addEventListener('mousemove', onMove);
            window.addEventListener('mouseup', onEnd);
            wheel.addEventListener('touchstart', onStart, { passive: false });
            window.addEventListener('touchmove', onMove, { passive: false });
            window.addEventListener('touchend', onEnd);
        })();

        // --- RECORDER ---
        let recorder, chunks = [], waveRegistry = {};
        let liveAnimFrame = null, liveAnalyser = null;

        function drawLiveWaveform() {
            const canvas = document.getElementById('liveWaveform');
            const ctx2d = canvas.getContext('2d');
            canvas.width = canvas.offsetWidth;
            const buf = new Uint8Array(liveAnalyser.fftSize);
            function draw() {
                if(!liveAnalyser) return;
                liveAnimFrame = requestAnimationFrame(draw);
                liveAnalyser.getByteTimeDomainData(buf);
                ctx2d.clearRect(0, 0, canvas.width, canvas.height);
                ctx2d.fillStyle = 'rgba(0,0,0,0)';
                ctx2d.strokeStyle = '#22c55e';
                ctx2d.lineWidth = 2;
                ctx2d.beginPath();
                const sliceW = canvas.width / buf.length;
                let x = 0;
                for(let i = 0; i < buf.length; i++) {
                    const v = buf[i] / 128.0;
                    const y = (v * canvas.height) / 2;
                    if(i === 0) ctx2d.moveTo(x, y); else ctx2d.lineTo(x, y);
                    x += sliceW;
                }
                ctx2d.lineTo(canvas.width, canvas.height / 2);
                ctx2d.stroke();
            }
            draw();
        }

        function stopLiveWaveform() {
            if(liveAnimFrame) { cancelAnimationFrame(liveAnimFrame); liveAnimFrame = null; }
            liveAnalyser = null;
            const canvas = document.getElementById('liveWaveform');
            canvas.style.display = 'none';
            const ctx2d = canvas.getContext('2d');
            ctx2d.clearRect(0, 0, canvas.width, canvas.height);
        }

        document.getElementById('recordToggle').onclick = async function() {
            if(recorder?.state === 'recording') {
                recorder.stop();
                stopLiveWaveform();
                this.textContent = "Start Recording"; this.classList.remove('is-active');
                document.getElementById('status').textContent = '';
                return;
            }
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            recorder = new MediaRecorder(stream); chunks = [];
            recorder.ondataavailable = e => chunks.push(e.data);
            recorder.onstop = () => {
                stream.getTracks().forEach(t => t.stop());
                const blob = new Blob(chunks, { type: 'audio/webm' });
                const item = { id: Date.now().toString(), blob, ts: Date.now() };
                const tx = db.transaction('memos', 'readwrite');
                tx.objectStore('memos').put(item);
                tx.oncomplete = renderMemos;
            };

            // Set up live waveform analyser
            const audioCtxLive = getCtx();
            liveAnalyser = audioCtxLive.createAnalyser();
            liveAnalyser.fftSize = 2048;
            const source = audioCtxLive.createMediaStreamSource(stream);
            source.connect(liveAnalyser);
            const canvas = document.getElementById('liveWaveform');
            canvas.style.display = 'block';
            drawLiveWaveform();

            recorder.start();
            this.textContent = "Stop Recording"; this.classList.add('is-active');
            document.getElementById('status').textContent = '‚óè Recording...';
        };

        function saveMemoName(m, newName) {
            m.name = newName.trim() || m.name;
            const tx = db.transaction('memos', 'readwrite');
            tx.objectStore('memos').put(m);
        }

        function renderMemos() {
            const list = document.getElementById('memoList'); list.innerHTML = '';
            db.transaction('memos').objectStore('memos').getAll().onsuccess = (e) => {
                e.target.result.sort((a,b)=>b.ts-a.ts).forEach(m => {
                    const url = URL.createObjectURL(m.blob);
                    const label = m.name || `Memo ‚Äî ${new Date(m.ts).toLocaleString()}`;
                    const d = document.createElement('div');
                    d.className = 'recording-item';
                    d.innerHTML = `
                        <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">
                            <strong id="lbl-${m.id}" style="flex:1;cursor:text;" title="Click to rename">${label}</strong>
                            <input id="inp-${m.id}" type="text" value="${label}"
                                style="display:none;flex:1;background:var(--bg);border:1px solid var(--primary);color:var(--text);
                                       border-radius:6px;padding:4px 8px;font-size:1rem;font-weight:700;outline:none;">
                            <button class="secondary" id="ren-${m.id}" style="padding:0.4rem 0.8rem;font-size:0.8rem;">‚úèÔ∏è Rename</button>
                        </div>
                        <div id="w-${m.id}" class="wf-box"></div>
                        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;">
                            <button class="main-action" id="p-${m.id}">Play</button>
                            <button class="secondary" id="dl-${m.id}">Export</button>
                            <button class="secondary" onclick="deleteMemo('${m.id}')">Delete</button>
                        </div>`;
                    list.appendChild(d);

                    const ws = WaveSurfer.create({ container: `#w-${m.id}`, waveColor: '#475569', progressColor: '#22c55e', url });
                    document.getElementById(`p-${m.id}`).onclick = () => ws.playPause();
                    document.getElementById(`dl-${m.id}`).onclick = () => {
                        const a = document.createElement('a');
                        a.href = url;
                        const safeName = (m.name || 'memo').replace(/[^a-z0-9_\- ]/gi,'_');
                        a.download = `${safeName}.webm`;
                        a.click();
                    };

                    // Rename logic
                    const lbl = document.getElementById(`lbl-${m.id}`);
                    const inp = document.getElementById(`inp-${m.id}`);
                    const renBtn = document.getElementById(`ren-${m.id}`);

                    function enterRename() {
                        inp.value = lbl.textContent;
                        lbl.style.display = 'none'; inp.style.display = 'block';
                        renBtn.textContent = '‚úì Save';
                        inp.focus(); inp.select();
                    }
                    function commitRename() {
                        const newName = inp.value.trim() || lbl.textContent;
                        lbl.textContent = newName; lbl.style.display = '';
                        inp.style.display = 'none'; renBtn.textContent = '‚úèÔ∏è Rename';
                        saveMemoName(m, newName);
                    }
                    renBtn.onclick = () => { if(inp.style.display === 'none') enterRename(); else commitRename(); };
                    lbl.onclick = enterRename;
                    inp.onblur = commitRename;
                    inp.onkeydown = (e) => { if(e.key === 'Enter') commitRename(); if(e.key === 'Escape') { inp.style.display='none'; lbl.style.display=''; renBtn.textContent='‚úèÔ∏è Rename'; } };
                });
            };
        }
        window.deleteMemo = (id) => {
            if(confirm("Delete this memo?")) {
                const tx = db.transaction('memos', 'readwrite');
                tx.objectStore('memos').delete(id);
                tx.oncomplete = renderMemos;
            }
        };

        initDB().then(() => { droneSync(); updateBPM(120); renderMemos(); });
    </script>
</body>
</html>